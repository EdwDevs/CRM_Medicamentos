<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Sistema profesional de gesti√≥n de pagos para medicamentos">
  <title>CRM Control de Pagos - Medicamentos</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    /* ============================================
        SISTEMA DE DISE√ëO - Variables CSS
        ============================================ */
    :root {
      /* Colores primarios */
      --primary-50: #eef2ff;
      --primary-100: #e0e7ff;
      --primary-500: #6366f1;
      --primary-600: #4f46e5;
      --primary-700: #4338ca;
      
      /* Colores secundarios */
      --secondary-500: #8b5cf6;
      --secondary-600: #7c3aed;
      
      /* Colores sem√°nticos */
      --success-500: #10b981;
      --success-600: #059669;
      --warning-500: #f59e0b;
      --warning-600: #d97706;
      --danger-500: #ef4444;
      --danger-600: #dc2626;
      --info-500: #06b6d4;
      --info-600: #0891b2;
      
      /* Neutros */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      /* Espaciado (escala 8pt) */
      --space-1: 0.5rem;   /* 8px */
      --space-2: 1rem;     /* 16px */
      --space-3: 1.5rem;   /* 24px */
      --space-4: 2rem;     /* 32px */
      --space-5: 2.5rem;   /* 40px */
      --space-6: 3rem;     /* 48px */
      
      /* Tipograf√≠a */
      --font-sans: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --font-size-4xl: 2.25rem;
      
      /* Sombras */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      
      /* Border radius */
      --radius-sm: 0.375rem;
      --radius: 0.5rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      --radius-full: 9999px;
      
      /* Transiciones */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* ============================================
        RESET Y BASE
        ============================================ */
    * {
      transition: background-color var(--transition-base), 
                  color var(--transition-base),
                  border-color var(--transition-base),
                  opacity var(--transition-base),
                  transform var(--transition-base);
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    html, body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      font-family: var(--font-sans);
      min-height: 100vh;
      color: var(--gray-900);
      line-height: 1.5;
    }
    
    /* ============================================
        HEADER
        ============================================ */
    .app-header {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: var(--gray-900);
      padding: var(--space-3) 0;
      box-shadow: var(--shadow-lg);
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 2px solid var(--primary-500);
    }
    
    .app-header h1 {
      font-weight: 800;
      font-size: var(--font-size-2xl);
      background: linear-gradient(135deg, var(--primary-600), var(--secondary-500));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--space-1);
    }
    
    .app-header .lead {
      color: var(--gray-600);
      font-size: var(--font-size-sm);
      font-weight: 500;
      margin: 0;
    }

    #user-id-display {
      font-size: 0.7rem;
      background-color: var(--primary-50);
      color: var(--primary-700);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      letter-spacing: 0.05em;
    }
    
    /* ============================================
        CARDS
        ============================================ */
    .card {
      border: 0;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      background: white;
      overflow: hidden;
      transition: transform var(--transition-base), 
                  box-shadow var(--transition-base);
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-2xl);
    }
    
    .card-header {
      border: 0;
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      color: white;
      font-weight: 700;
      padding: var(--space-3);
      font-size: var(--font-size-lg);
      letter-spacing: 0.025em;
    }
    
    .card-body {
      padding: var(--space-3);
    }

    /* Estilo para la tarjeta de IA */
    .gemini-card-header {
      background: linear-gradient(135deg, var(--secondary-600), var(--primary-600));
    }

    .gemini-result {
      background: var(--gray-50);
      border-radius: var(--radius-md);
      padding: var(--space-2);
      white-space: pre-wrap;
      font-family: var(--font-sans);
      font-size: var(--font-size-sm);
      border: 1px solid var(--gray-200);
    }

    .gemini-loader {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      color: var(--gray-600);
      font-weight: 500;
    }
    
    /* ============================================
        STATS CARDS
        ============================================ */
    .stats-card {
      padding: var(--space-3);
      text-align: center;
      position: relative;
      overflow: hidden;
      height: 100%;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .stats-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-500), var(--secondary-500));
    }
    
    .stats-card .stat-icon-bg {
      position: absolute;
      right: var(--space-2);
      top: 50%;
      transform: translateY(-50%);
      font-size: 4rem;
      opacity: 0.08;
      color: var(--primary-500);
    }
    
    .stats-card .number {
      font-size: var(--font-size-4xl);
      font-weight: 900;
      background: linear-gradient(135deg, var(--primary-600), var(--secondary-500));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--space-1);
      line-height: 1;
      position: relative;
      z-index: 1;
    }
    
    .stats-card .label {
      color: var(--gray-600);
      font-weight: 600;
      font-size: var(--font-size-xs);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: relative;
      z-index: 1;
    }
    
    /* ============================================
        BUDGET CARD
        ============================================ */
    .budget-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .budget-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
      animation: pulse-glow 4s ease-in-out infinite;
    }
    
    @keyframes pulse-glow {
      0%, 100% { 
        transform: scale(1); 
        opacity: 0.5; 
      }
      50% { 
        transform: scale(1.15); 
        opacity: 0.8; 
      }
    }
    
    .budget-card .number {
      color: white !important;
      text-shadow: 0 4px 12px rgba(0,0,0,0.2);
      -webkit-text-fill-color: white;
      font-size: var(--font-size-3xl);
    }
    
    .budget-card .label {
      color: rgba(255,255,255,0.95);
      font-weight: 600;
      font-size: var(--font-size-sm);
    }
    
    .budget-info {
      background: rgba(255,255,255,0.15);
      border-radius: var(--radius-lg);
      padding: var(--space-3);
      margin-top: var(--space-3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    /* ============================================
        BADGES
        ============================================ */
    .badge-descongel {
      background: linear-gradient(135deg, var(--info-500), var(--info-600));
      padding: 0.5rem 1rem;
      border-radius: var(--radius-full);
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
      font-size: var(--font-size-sm);
    }
    
    .badge-multidol400 {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
      padding: 0.5rem 1rem;
      border-radius: var(--radius-full);
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      font-size: var(--font-size-sm);
    }
    
    .badge-multidol800 {
      background: linear-gradient(135deg, var(--secondary-500), var(--secondary-600));
      padding: 0.5rem 1rem;
      border-radius: var(--radius-full);
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      font-size: var(--font-size-sm);
    }
    
    /* ============================================
        STATUS BUTTONS
        ============================================ */
    .status-toggle-btn {
      border: none !important;
      border-radius: var(--radius-full);
      padding: 0.5rem 1.25rem;
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow-md);
      transition: all var(--transition-base);
    }
    
    .status-toggle-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .status-toggle-btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow);
    }
    
    .status-toggle-btn:focus-visible {
      outline: 3px solid var(--primary-500);
      outline-offset: 2px;
    }
    
    /* ============================================
        STATUS STATS
        ============================================ */
    .status-stats {
      background: linear-gradient(135deg, var(--secondary-500), var(--secondary-600));
      color: white;
    }
    
    .status-stats.success-stat {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
    }
    
    .status-stats.warning-stat {
      background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
    }
    
    .status-stats .number {
      color: white !important;
      -webkit-text-fill-color: white;
    }
    
    .status-stats .label {
      color: rgba(255,255,255,0.95);
    }
    
    /* ============================================
        TOAST NOTIFICATIONS
        ============================================ */
    .toast-notification {
      position: fixed;
      top: var(--space-3);
      right: var(--space-3);
      background: white;
      color: var(--gray-900);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2xl);
      z-index: 2000;
      animation: slideIn var(--transition-slow) ease;
      border-left: 4px solid var(--success-500);
      min-width: 300px;
      max-width: 500px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    .toast-notification.fade-out {
      opacity: 0;
    }
    
    .toast-error {
      border-left-color: var(--danger-500);
    }
    
    @keyframes slideIn {
      from { 
        transform: translateX(120%); 
        opacity: 0; 
      }
      to { 
        transform: translateX(0); 
        opacity: 1; 
      }
    }
    
    /* ============================================
        LOADING SKELETON
        ============================================ */
    .loading-skeleton {
      height: 16px;
      background: linear-gradient(90deg, 
        var(--gray-200) 0%, 
        var(--gray-100) 20%, 
        var(--gray-200) 40%, 
        var(--gray-200) 100%);
      background-size: 200% 100%;
      animation: skeleton 1.5s ease-in-out infinite;
      border-radius: var(--radius);
    }
    
    @keyframes skeleton {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .skeleton-card {
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      background: white;
    }
    
    /* ============================================
        TABLE
        ============================================ */
    .table-responsive {
      border-radius: var(--radius-lg);
      overflow: hidden;
    }
    
    .table {
      border-collapse: separate;
      border-spacing: 0 var(--space-1);
      margin-bottom: 0;
    }
    
    .table thead th {
      background: var(--gray-50);
      color: var(--gray-700);
      font-weight: 700;
      text-transform: uppercase;
      font-size: var(--font-size-xs);
      letter-spacing: 0.05em;
      padding: var(--space-2) var(--space-2);
      border: none;
      white-space: nowrap;
    }
    
    .table tbody tr {
      background: white;
      box-shadow: var(--shadow);
      transition: all var(--transition-base);
    }
    
    .table tbody tr:hover {
      transform: scale(1.01);
      box-shadow: var(--shadow-lg);
      z-index: 1;
    }
    
    .table tbody td {
      padding: var(--space-2) var(--space-2);
      border: none;
      vertical-align: middle;
      font-size: var(--font-size-sm);
    }
    
    .table tbody tr td:first-child {
      border-radius: var(--radius-md) 0 0 var(--radius-md);
    }
    
    .table tbody tr td:last-child {
      border-radius: 0 var(--radius-md) var(--radius-md) 0;
    }
    
    /* ============================================
        ACTION BUTTONS
        ============================================ */
    .action-buttons {
      display: flex;
      gap: var(--space-1);
      justify-content: flex-end;
    }
    
    .action-buttons .btn {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all var(--transition-base);
    }
    
    .action-buttons .btn:hover {
      transform: translateY(-2px);
    }
    
    .action-buttons .btn:focus-visible {
      outline: 3px solid var(--primary-500);
      outline-offset: 2px;
    }
    
    .btn-outline-secondary:hover {
      background: var(--info-500);
      border-color: var(--info-500);
      color: white;
    }
    
    .btn-outline-danger:hover {
      background: var(--danger-500);
      border-color: var(--danger-500);
      color: white;
    }
    
    /* ============================================
        FORMS
        ============================================ */
    .form-control, .form-select {
      min-height: 48px;
      border-radius: var(--radius-md);
      border: 2px solid var(--gray-200);
      padding: var(--space-2);
      transition: all var(--transition-base);
      font-size: var(--font-size-base);
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-500);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      outline: none;
    }
    
    .form-control:disabled, .form-select:disabled {
      background-color: var(--gray-50);
      cursor: not-allowed;
    }
    
    .form-label {
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: var(--space-1);
      font-size: var(--font-size-sm);
    }
    
    .form-label i {
      color: var(--primary-500);
    }
    
    /* ============================================
        BUTTONS
        ============================================ */
    .btn {
      min-height: 48px;
      border-radius: var(--radius-md);
      font-weight: 600;
      transition: all var(--transition-base);
      font-size: var(--font-size-base);
      padding: var(--space-2) var(--space-3);
      border: 2px solid transparent;
    }
    
    .btn:focus-visible {
      outline: 3px solid var(--primary-500);
      outline-offset: 2px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-600), var(--secondary-500));
      border: none;
      box-shadow: var(--shadow-lg);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
      background: linear-gradient(135deg, var(--primary-700), var(--secondary-600));
    }
    
    .btn-primary:active {
      transform: translateY(0);
      box-shadow: var(--shadow-md);
    }

    .btn-primary:disabled {
      background: var(--gray-300);
      box-shadow: none;
      transform: none;
    }
    
    .btn-outline-light {
      border-color: rgba(255,255,255,0.8);
      color: white;
    }
    
    .btn-outline-light:hover {
      background: white;
      color: var(--primary-600);
    }

    .btn-danger {
      background-color: var(--danger-600);
      border-color: var(--danger-600);
    }
    .btn-danger:hover {
      background-color: var(--danger-700);
      border-color: var(--danger-700);
    }
    
    /* ============================================
        MODAL
        ============================================ */
    .modal-content {
      border: 0;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-2xl);
      overflow: hidden;
    }
    
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }

    /* Estilo para el modal de confirmaci√≥n de peligro */
    #confirmModal .modal-header {
      background: linear-gradient(135deg, var(--danger-500), var(--danger-600));
      color: white;
      font-weight: 700;
      border-bottom: 0;
      padding: var(--space-3);
    }

    #confirmModal .modal-body {
      padding: var(--space-3);
      font-size: var(--font-size-lg);
      color: var(--gray-700);
    }

    #confirmModal .modal-footer {
      border-top: 0;
      padding: var(--space-3);
    }
    
    /* ============================================
        FAB BUTTON
        ============================================ */
    .fab-button {
      background: linear-gradient(135deg, var(--primary-600), var(--secondary-500));
      box-shadow: var(--shadow-xl);
      transition: all var(--transition-slow);
      border: none;
      color: white;
    }
    
    .fab-button:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 20px 40px rgba(99, 102, 241, 0.5);
      background: linear-gradient(135deg, var(--primary-700), var(--secondary-600));
    }
    
    .fab-button:active {
      transform: scale(1.05) rotate(90deg);
    }
    
    .fab-button:focus-visible {
      outline: 4px solid rgba(99, 102, 241, 0.5);
      outline-offset: 4px;
    }
    
    /* ============================================
        PROGRESS BAR
        ============================================ */
    .progress {
      height: 12px;
      border-radius: var(--radius-full);
      background: rgba(255,255,255,0.2);
      overflow: hidden;
    }
    
    .progress-bar {
      border-radius: var(--radius-full);
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* ============================================
        ALERTS
        ============================================ */
    #budget-alert {
      animation: shake 0.5s ease;
      border-radius: var(--radius-lg);
      padding: var(--space-3);
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    /* ============================================
        EMPTY STATE
        ============================================ */
    .empty-state {
      padding: var(--space-6) var(--space-3);
      text-align: center;
      color: var(--gray-500);
    }
    
    .empty-state-icon {
      font-size: 4rem;
      color: var(--gray-300);
      margin-bottom: var(--space-3);
    }
    
    .empty-state-title {
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--gray-700);
      margin-bottom: var(--space-2);
    }
    
    .empty-state-text {
      font-size: var(--font-size-base);
      color: var(--gray-500);
    }
    
    /* ============================================
        FOOTER
        ============================================ */
    footer {
      color: white;
      margin-top: var(--space-6);
      padding: var(--space-4) 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      font-size: var(--font-size-sm);
    }
    
    /* ============================================
        FILTER TOGGLE (Mobile)
        ============================================ */
    .filter-toggle {
      display: none;
    }
    
    @media (max-width: 768px) {
      .filter-toggle {
        display: block;
      }
      
      .filters-collapsible {
        margin-top: var(--space-2);
      }
    }
    
    /* ============================================
        RESPONSIVE
        ============================================ */
    @media (max-width: 768px) {
      .app-header h1 {
        font-size: var(--font-size-xl);
      }
      
      .table thead {
        display: none;
      }
      
      .table tbody tr {
        display: block;
        background: white;
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-2);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
      }
      
      .table tbody td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        border-bottom: 1px solid var(--gray-100);
      }
      
      .table tbody td:last-child {
        border-bottom: 0;
      }
      
      .table tbody td::before {
        content: attr(data-label);
        font-weight: 700;
        color: var(--gray-700);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      .stats-card .number {
        font-size: var(--font-size-3xl);
      }
      
      .action-buttons {
        width: 100%;
        justify-content: center;
      }
      
      .toast-notification {
        right: var(--space-2);
        left: var(--space-2);
        min-width: auto;
      }
    }
    
    /* ============================================
        UTILITIES
        ============================================ */
    .text-gradient {
      background: linear-gradient(135deg, var(--primary-600), var(--secondary-500));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* Accessibility: Reduce motion */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .card {
        border: 2px solid var(--gray-900);
      }
      
      .btn {
        border: 2px solid currentColor;
      }
    }
  </style>

  <!-- Firebase SDKs - v11.6.1 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signInAnonymously, 
      signInWithCustomToken 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      deleteDoc,
      doc,
      query,
      where,
      orderBy,
      updateDoc,
      onSnapshot,
      Timestamp,
      setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURACI√ìN GLOBAL DE LA APP ---

    // ***** INICIO DE LA MODIFICACI√ìN *****
    // PARA PRUEBAS LOCALES: Configuraci√≥n de Firebase pre-llenada con tus claves originales.
    // Si est√°s en un entorno (como Canvas) que inyecta las variables globales, ESTO SE IGNORAR√Å.
    const localFirebaseConfig = {
      apiKey: "AIzaSyDK2Aoz1kxq1dDXKkemRIYCFAFtxgw4dZs",
      authDomain: "crm-medicamentos.firebaseapp.com",
      projectId: "crm-medicamentos",
      storageBucket: "crm-medicamentos.appspot.com",
      messagingSenderId: "638953546971",
      appId: "1:638953546971:web:4f811cdd7dd72dc7cfd8fe"
    };
    // ***** FIN DE LA MODIFICACI√ìN *****

    // Obtener config/auth del entorno (¬°No hardcodear!)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // FIX: Robust JSON parsing
    let firebaseConfig = {};
    try {
      if (typeof __firebase_config === 'string' && __firebase_config.trim().startsWith('{')) {
         firebaseConfig = JSON.parse(__firebase_config);
         console.log("Configuraci√≥n global __firebase_config cargada.");
      } else if (localFirebaseConfig.apiKey) {
         firebaseConfig = localFirebaseConfig;
         console.log("Usando localFirebaseConfig para pruebas.");
      }
    } catch (e) {
       console.error("Error al parsear __firebase_config. Usando config vac√≠a.", e);
       // firebaseConfig permanece como {}
    }
    
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Estado global de la aplicaci√≥n
    const appState = {
      db: null,
      auth: null,
      userId: null,
      paymentsUnsubscribe: null,
      formModal: null,
      detailsModal: null,
      confirmModal: null
    };

    const BUDGET_TOTAL = 500000;
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    const PRODUCTS = {
      descongel: {name: "Descongel x100 c√°psulas", cls: "descongel", icon: "‚ùÑÔ∏è"},
      multidol400: {name: "Multidol 400mg", cls: "multidol400", icon: "üíä"},
      multidol800: {name: "Multidol 800mg", cls: "multidol800", icon: "üíä"}
    };
    
    // --- FUNCIONES UTILITARIAS ---

    function getProductName(k) { return (PRODUCTS[k]?.name) || k }
    function getProductClass(k) { return (PRODUCTS[k]?.cls) || "" }
    function getProductIcon(k) { return (PRODUCTS[k]?.icon) || "üì¶" }
    
    function getPaymentStatus(s) {
      const map = {
        pendiente: {label: "Pendiente", class: "bg-warning text-dark", icon: "‚è≥"},
        procesado: {label: "Procesado", class: "bg-success text-white", icon: "‚úÖ"}
      };
      return map[s] || map.pendiente;
    }

    function toDate(d) {
      if (d instanceof Date) return d;
      if (d?.toDate) return d.toDate(); // Firestore Timestamp
      if (typeof d === "string") return new Date(d + "T00:00:00"); // Asumir local
      return new Date(d);
    }

    function formatDate(d) {
      const dt = toDate(d);
      return dt.toLocaleDateString("es-CO", {year: "numeric", month: "short", day: "numeric"});
    }

    function formatCurrency(v) {
      const n = Number(v || 0);
      return new Intl.NumberFormat("es-CO", {style: "currency", currency: "COP", minimumFractionDigits: 0, maximumFractionDigits: 0}).format(n);
    }

    function showToast(msg, type = "success") {
      const id = "toast-" + Date.now();
      const icon = type === "success" ? "check-circle" : "exclamation-circle";
      const el = document.createElement("div");
      el.id = id;
      el.className = `toast-notification ${type === "error" ? "toast-error" : ""}`;
      el.setAttribute('role', 'alert');
      el.setAttribute('aria-live', 'polite');
      el.innerHTML = `<i class="fas fa-${icon} me-2"></i>${msg}`;
      document.body.appendChild(el);
      setTimeout(() => {
        el.classList.add('fade-out');
        setTimeout(() => el.remove(), 300);
      }, 3500);
    }

    function spinnerRow() {
      return `
        <tr>
          <td colspan="9">
            <div class="skeleton-card">
              <div class="loading-skeleton mb-2" style="height:20px;width:40%"></div>
              <div class="loading-skeleton mb-2" style="height:16px;width:85%"></div>
              <div class="loading-skeleton" style="height:16px;width:70%"></div>
            </div>
          </td>
        </tr>`;
    }

    function calculateTotal() {
      const q = Number($('#quantity').value || 0);
      const up = Number($('#unitPrice').value || 0);
      const total = q * up;
      $('#total-display').textContent = formatCurrency(total);
      $('#total-value').value = String(total);
      $('#total-container').style.display = (q > 0 && up > 0) ? 'block' : 'none';
    }

    // --- L√ìGICA DE GEMINI API ---

    /**
     * Llama a la API de Gemini v1.5 Flash con reintentos.
     * @param {string} userQuery - El prompt del usuario.
     * @param {string | null} systemPrompt - El prompt del sistema (opcional).
     * @param {boolean} useGrounding - Si se debe usar Google Search grounding (opcional).
     * @returns {Promise<string | null>} - El texto de la respuesta o null si falla.
     */
    async function callGemini(userQuery, systemPrompt = null, useGrounding = false) {
      const apiKey = ""; // La clave se inyecta en el entorno
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

      const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
      };

      if (systemPrompt) {
        payload.systemInstruction = {
          parts: [{ text: systemPrompt }]
        };
      }

      if (useGrounding) {
        payload.tools = [{ "google_search": {} }];
      }

      let delay = 1000;
      for (let i = 0; i < 3; i++) { // 3 intentos
        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          const candidate = result.candidates?.[0];

          if (candidate && candidate.content?.parts?.[0]?.text) {
            return candidate.content.parts[0].text;
          } else {
            console.warn("Respuesta de Gemini inesperada:", result);
            return null; // Formato de respuesta no esperado
          }

        } catch (error) {
          console.error(`Intento ${i + 1} fallido:`, error);
          if (i < 2) {
            await new Promise(res => setTimeout(res, delay));
            delay *= 2;
          }
        }
      }
      return null; // Fall√≥ despu√©s de todos los intentos
    }

    /**
     * 1. GEMINI: Genera el Resumen Ejecutivo del Dashboard
     */
    async function handleGenerateSummary() {
      const btn = $('#gemini-summary-btn');
      const loader = $('#gemini-summary-loader');
      const resultEl = $('#gemini-summary-result');

      btn.disabled = true;
      loader.style.display = 'block';
      resultEl.style.display = 'none';

      // Recopilar KPIs
      const kpis = {
        totalPagado: $('#total-pagado').textContent,
        presupuestoRestante: $('#presupuesto-restante').textContent,
        porcentajeUsado: $('#porcentaje-usado').textContent,
        totalPagos: $('#total-pagos').textContent,
        totalDescongel: $('#total-descongel').textContent,
        totalMultidol400: $('#total-multidol400').textContent,
        totalMultidol800: $('#total-multidol800').textContent,
        totalPendientes: $('#total-pendientes').textContent,
        totalProcesados: $('#total-procesados').textContent,
      };

      // Recopilar Filtros
      const filters = {
        producto: $('#filter-product').value || "Todos",
        farmacia: $('#filter-pharmacy').value || "Todas",
        estado: $('#filter-status').value || "Todos",
        mes: $('#filter-date').value || "Todos",
      };

      const systemPrompt = "Eres un analista financiero para un distribuidor de medicamentos. Tu trabajo es crear un resumen ejecutivo breve y accionable (3-4 frases) basado en los datos de gastos y los filtros aplicados. S√© directo y profesional.";
      const userQuery = `
        Datos de KPIs Actuales:
        ${JSON.stringify(kpis, null, 2)}

        Filtros Aplicados:
        ${JSON.stringify(filters, null, 2)}

        Basado en estos datos y filtros, genera el resumen ejecutivo.
      `;

      const summary = await callGemini(userQuery, systemPrompt);

      loader.style.display = 'none';
      if (summary) {
        resultEl.textContent = summary;
        resultEl.style.display = 'block';
      } else {
        showToast("‚ùå No se pudo generar el resumen de IA.", "error");
      }
      btn.disabled = false;
    }

    /**
     * 2. GEMINI: Optimiza la nota del formulario
     */
    async function handleOptimizeNotes() {
      const btn = $('#gemini-notes-btn');
      const loader = $('#gemini-notes-loader');
      const textarea = $('#notes');
      
      const originalText = textarea.value;
      if (!originalText.trim()) {
        showToast("‚ö†Ô∏è Escribe una nota para optimizar.", "error");
        return;
      }

      btn.disabled = true;
      loader.style.display = 'block';

      const systemPrompt = "Eres un asistente de CRM. Reescribe la siguiente nota de pago para que sea m√°s profesional, clara y concisa, pero mant√©n todos los detalles clave. Responde √∫nicamente con la nota reescrita.";
      const userQuery = `Nota original: "${originalText}"`;

      const optimizedNote = await callGemini(userQuery, systemPrompt);

      loader.style.display = 'none';
      btn.disabled = false;

      if (optimizedNote) {
        textarea.value = optimizedNote.trim().replace(/^"|"$/g, ''); // Limpiar comillas
        showToast("‚ú® Nota optimizada por IA.", "success");
      } else {
        showToast("‚ùå No se pudo optimizar la nota.", "error");
      }
    }

    /**
     * 3. GEMINI: Busca informaci√≥n de la farmacia (con Grounding)
     */
    async function handleFetchPharmacyInfo() {
      const btn = $('#gemini-pharmacy-btn');
      const loader = $('#gemini-pharmacy-loader');
      const resultEl = $('#gemini-pharmacy-result');
      const input = $('#pharmacy');

      const pharmacyName = input.value;
      if (!pharmacyName.trim()) {
        showToast("‚ö†Ô∏è Escribe un nombre de farmacia para buscar.", "error");
        return;
      }

      btn.disabled = true;
      loader.style.display = 'block';
      resultEl.style.display = 'none';

      const systemPrompt = "Eres un asistente que busca informaci√≥n de empresas. Responde con un resumen de una sola frase sobre la farmacia indicada, basado en la b√∫squeda de Google.";
      const userQuery = `Dame un resumen de una frase sobre esta farmacia: "${pharmacyName}"`;

      const info = await callGemini(userQuery, systemPrompt, true); // true = usar grounding

      loader.style.display = 'none';
      btn.disabled = false;

      if (info) {
        resultEl.textContent = info;
        resultEl.style.display = 'block';
      } else {
        showToast("‚ùå No se pudo encontrar informaci√≥n.", "error");
      }
    }


    // --- L√ìGICA DE FIREBASE ---

    /**
     * Inicializa Firebase y maneja la autenticaci√≥n del usuario.
     */
    async function initFirebase() {
      // La comprobaci√≥n de apiKey se hace aqu√≠, despu√©s de que firebaseConfig se haya poblado
      if (!firebaseConfig.apiKey) {
        console.error("Configuraci√≥n de Firebase no encontrada o inv√°lida. La app no funcionar√°.");
        showToast("Error cr√≠tico: Falta configuraci√≥n", "error");
        return;
      }

      try {
        const app = initializeApp(firebaseConfig);
        appState.db = getFirestore(app);
        appState.auth = getAuth(app);
        setLogLevel('Debug'); // Habilitar logs de Firestore

        if (initialAuthToken) {
          await signInWithCustomToken(appState.auth, initialAuthToken);
        } else {
          await signInAnonymously(appState.auth);
        }

        // El listener principal que arranca la app post-auth
        onAuthStateChanged(appState.auth, (user) => {
          if (user) {
            appState.userId = user.uid;
            console.log("Usuario autenticado:", appState.userId);
            $('#user-id-display').textContent = `ID: ${appState.userId}`;
            // Ahora que tenemos usuario, cargamos los datos
            loadPayments(); 
          } else {
            appState.userId = null;
            if (appState.paymentsUnsubscribe) appState.paymentsUnsubscribe();
            console.warn("Usuario no autenticado.");
          }
        });

      } catch (e) {
        console.error("Error inicializando Firebase:", e);
        showToast("No se pudo conectar a Firebase", "error");
      }
    }

    /**
     * Funci√≥n as√≠ncrona para rellenar estados faltantes.
     * Se ejecuta en segundo plano sin bloquear la UI.
     */
    function backfillMissingStatus(docs) {
      const toFix = docs.filter(d => !("status" in d.data()));
      if (toFix.length === 0) return;

      console.log(`Rellenando ${toFix.length} registros sin estado...`);
      const batchSize = Math.min(toFix.length, 10);
      
      for(let i = 0; i < batchSize; i++) {
        const docRef = doc(appState.db, "artifacts", appId, "users", appState.userId, "payments", toFix[i].id);
        updateDoc(docRef, { status: "pendiente" })
          .catch(e => console.warn("Error en backfill:", e));
      }
    }

    /**
     * Normaliza los datos del cliente para consistencia.
     */
    function normalizeClientData(payments) {
      return payments.map(p => {
        const date = toDate(p.date);
        const unitPrice = Number(p.unitPrice ?? p.amount ?? 0);
        const totalAmount = Number(p.totalAmount ?? p.amount ?? (Number(p.quantity || 1) * unitPrice));
        const status = p.status || "pendiente";
        return {...p, date, unitPrice, totalAmount, status};
      });
    }

    /**
     * Carga los pagos usando onSnapshot para datos en tiempo real.
     */
    function loadPayments() {
      if (!appState.userId || !appState.db) {
        console.warn("Intento de carga sin autenticaci√≥n.");
        return;
      }

      // Cancelar cualquier listener anterior
      if (appState.paymentsUnsubscribe) {
        appState.paymentsUnsubscribe();
      }

      const tbody = $('#payments-table');
      tbody.innerHTML = spinnerRow() + spinnerRow() + spinnerRow();

      // Construir la consulta din√°mica
      const pf = $('#filter-product').value || "";
      const phf = $('#filter-pharmacy').value || "";
      const df = $('#filter-date').value || "";
      const sf = $('#filter-status').value || "";

      const constraints = [];
      if (df) {
        const start = new Date(df + "-01T00:00:00");
        const end = new Date(start); 
        end.setMonth(end.getMonth() + 1);
        constraints.push(where("date", ">=", start));
        constraints.push(where("date", "<", end));
      }
      if (pf) constraints.push(where("product", "==", pf));
      if (phf) constraints.push(where("pharmacy", "==", phf));
      if (sf) constraints.push(where("status", "==", sf));
      
      // La consulta de ordenaci√≥n DEBE coincidir con el campo de rango (date)
      constraints.push(orderBy("date", "desc"));

      try {
        const collectionPath = collection(appState.db, "artifacts", appId, "users", appState.userId, "payments");
        const qy = query(collectionPath, ...constraints);

        // Escuchar cambios en tiempo real
        appState.paymentsUnsubscribe = onSnapshot(qy, (snap) => {
          const payments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderPayments(payments);
          
          // Ejecutar el backfill en segundo plano
          backfillMissingStatus(snap.docs);

        }, (error) => {
          console.error("Error en onSnapshot, ¬øfalta √≠ndice?:", error);
          tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger py-4">
            <i class="fas fa-exclamation-triangle me-2"></i>Error al cargar datos.
          </td></tr>`;
          
          // Mostrar ayuda para crear el √≠ndice
          const msg = String(error?.message || "");
          const match = msg.match(/https:\/\/console\.firebase\.google\.com\/[^\s]+/);
          if (match) {
            showIndexHelp(match[0]);
          }
        });

      } catch (error) {
        console.error("Error al construir la consulta:", error);
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger py-4">
          <i class="fas fa-exclamation-triangle me-2"></i>Error grave en la aplicaci√≥n.
        </td></tr>`;
      }
    }

    function showIndexHelp(url) {
      const tbody = $('#payments-table');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td colspan="9" class="text-center text-warning py-3">
          <i class="fa-solid fa-triangle-exclamation me-2"></i>
          Esta combinaci√≥n de filtros requiere un √≠ndice compuesto en Firestore.
          <a href="${url}" target="_blank" rel="noopener" class="ms-1 fw-bold">Crear √≠ndice aqu√≠</a>
        </td>`;
      tbody.prepend(row);
    }

    function renderPayments(raw) {
      const tbody = $('#payments-table');
      tbody.innerHTML = "";
      const payments = normalizeClientData(raw);

      payments.forEach(p => {
        const st = getPaymentStatus(p.status);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Fecha">${formatDate(p.date)}</td>
          <td data-label="Farmacia"><strong>${p.pharmacy || "-"}</strong></td>
          <td data-label="Producto">
            <span class="me-2" style="font-size:1.5rem" role="img" aria-label="${getProductName(p.product)}">${getProductIcon(p.product)}</span>
            <span class="badge badge-${getProductClass(p.product)}">${getProductName(p.product)}</span>
          </td>
          <td data-label="Cant."><strong>${p.quantity || 1}</strong></td>
          <td data-label="Valor Unit.">${formatCurrency(p.unitPrice)}</td>
          <td data-label="Total"><strong>${formatCurrency(p.totalAmount)}</strong></td>
          <td data-label="Estado" class="text-center">
            <button class="btn btn-sm status-toggle-btn ${st.class}" 
                    data-action="toggle" 
                    data-id="${p.id}" 
                    data-status="${p.status}" 
                    title="Cambiar estado"
                    aria-label="Cambiar estado del pago">
              ${st.icon} ${st.label}
            </button>
          </td>
          <td data-label="Descripci√≥n">
            <small class="text-muted">${p.notes ? (p.notes.length > 60 ? p.notes.slice(0, 60) + "‚Ä¶" : p.notes) : "Sin descripci√≥n"}</small>
          </td>
          <td data-label="Acciones" class="action-buttons">
            <button class="btn btn-sm btn-outline-secondary" 
                    data-action="view" 
                    data-id="${p.id}" 
                    title="Ver detalles"
                    aria-label="Ver detalles del pago">
              <i class="fas fa-eye" aria-hidden="true"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" 
                    data-action="delete" 
                    data-id="${p.id}" 
                    title="Eliminar"
                    aria-label="Eliminar pago">
              <i class="fas fa-trash" aria-hidden="true"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      if (payments.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="9">
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="fa-regular fa-folder-open"></i>
              </div>
              <div class="empty-state-title">No hay pagos registrados</div>
              <div class="empty-state-text">No se encontraron pagos con los filtros aplicados.</div>
            </div>
          </td></tr>`;
      }

      updateStats(payments);
      updatePharmacyFilter(payments);
    }

    function updateStats(payments) {
      $('#total-pagos').textContent = payments.length;

      const c = (k) => payments.filter(p => p.product === k).length;
      $('#total-descongel').textContent = c('descongel');
      $('#total-multidol400').textContent = c('multidol400');
      $('#total-multidol800').textContent = c('multidol800');

      const pend = payments.filter(p => p.status === 'pendiente').length;
      const proc = payments.filter(p => p.status === 'procesado').length;
      $('#total-pendientes').textContent = pend;
      $('#total-procesados').textContent = proc;

      const total = payments.reduce((s, p) => s + Number(p.totalAmount || 0), 0);
      const restante = BUDGET_TOTAL - total;
      const pct = (total / BUDGET_TOTAL) * 100;

      $('#total-pagado').textContent = formatCurrency(total);
      $('#presupuesto-restante').textContent = formatCurrency(restante);
      $('#porcentaje-usado').textContent = `${isFinite(pct) ? pct.toFixed(1) : 0}%`;

      const bar = $('#budget-progress');
      bar.style.width = `${Math.min(pct, 100)}%`;
      bar.setAttribute('aria-valuenow', Math.min(pct, 100));
      bar.className = 'progress-bar';
      if (pct >= 90) { bar.classList.add('bg-danger') }
      else if (pct >= 75) { bar.classList.add('bg-warning') }
      else { bar.classList.add('bg-success') }

      const alert = $('#budget-alert');
      if (total > BUDGET_TOTAL) {
        alert.style.display = 'block';
        $('#exceso-presupuesto').textContent = formatCurrency(total - BUDGET_TOTAL);
      } else {
        alert.style.display = 'none';
      }
    }

    function updatePharmacyFilter(payments) {
      const sel = $('#filter-pharmacy');
      const current = sel.value;
      const names = [...new Set(payments.map(p => p.pharmacy).filter(Boolean))].sort();
      sel.innerHTML = '<option value="">Todas</option>';
      names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n; opt.textContent = n; sel.appendChild(opt);
      });
      if (names.includes(current)) sel.value = current;
    }

    async function addPayment(payload, btn) {
      const originalHtml = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i> Guardando...`;

      try {
        const collectionPath = collection(appState.db, "artifacts", appId, "users", appState.userId, "payments");
        await addDoc(collectionPath, payload);
        
        const info = getPaymentStatus(payload.status);
        showToast(`‚úÖ Pago registrado como: ${info.label}`, "success");
        return true; // √âxito
      } catch (e) {
        console.error(e); 
        showToast("‚ùå Error al registrar el pago", "error");
        return false; // Fallo
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    }

    async function confirmDeletePayment() {
      const id = $('#confirmModal').dataset.deleteId;
      if (!id) return;

      const btn = $('#confirm-modal-btn');
      btn.disabled = true;

      try {
        const docRef = doc(appState.db, "artifacts", appId, "users", appState.userId, "payments", id);
        await deleteDoc(docRef);
        showToast("üóëÔ∏è Pago eliminado correctamente", "success");
        appState.confirmModal.hide();
      } catch (e) {
        console.error(e); 
        showToast("‚ùå Error al eliminar el pago", "error");
      } finally {
        btn.disabled = false;
        delete $('#confirmModal').dataset.deleteId;
      }
    }

    function promptDeletePayment(id) {
      $('#confirmModal').dataset.deleteId = id;
      $('#confirm-modal-body').textContent = "¬øEst√° seguro de eliminar este pago? Esta acci√≥n no se puede deshacer.";
      appState.confirmModal.show();
    }

    async function togglePaymentStatus(id, currentStatus) {
      const next = currentStatus === "pendiente" ? "procesado" : "pendiente";
      try {
        const docRef = doc(appState.db, "artifacts", appId, "users", appState.userId, "payments", id);
        await updateDoc(docRef, {status: next});
        
        const info = getPaymentStatus(next);
        showToast(`${info.icon} Estado cambiado a: ${info.label}`, "success");
        // No es necesario llamar a loadPayments(), onSnapshot lo har√°
      } catch (e) {
        console.error(e); 
        showToast("‚ùå Error al cambiar el estado", "error");
      }
    }

    function viewPayment(id) {
      const docRef = doc(appState.db, "artifacts", appId, "users", appState.userId, "payments", id);
      
      const unsub = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
          openDetailsModal({id: docSnap.id, ...docSnap.data()});
        } else {
          showToast("No se encontraron detalles del pago.", "error");
        }
        unsub(); // Dejar de escuchar despu√©s de la primera lectura
      }, (e) => {
        console.error(e);
        showToast("‚ùå Error al obtener detalles del pago", "error");
      });
    }

    function openDetailsModal(payment) {
      const modalTitle = $('#detailsTitle');
      const modalBody = $('#detailsBody');
      const dt = toDate(payment.date);
      const status = getPaymentStatus(payment.status || 'pendiente');

      modalTitle.textContent = `Pago ‚Ä¢ ${getProductName(payment.product)}`;
      modalBody.innerHTML = `
        <div class="d-flex align-items-center mb-3">
          <span class="me-2" style="font-size:2.5rem" role="img" aria-label="${getProductName(payment.product)}">${getProductIcon(payment.product)}</span>
          <span class="badge badge-${getProductClass(payment.product)}">${getProductName(payment.product)}</span>
        </div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>Farmacia:</strong> ${payment.pharmacy || "-"}</li>
          <li class="list-group-item"><strong>Fecha:</strong> ${formatDate(dt)}</li>
          <li class="list-group-item"><strong>Cantidad:</strong> ${payment.quantity || 1}</li>
          <li class="list-group-item"><strong>Valor Unitario:</strong> ${formatCurrency(payment.unitPrice ?? payment.amount ?? 0)}</li>
          <li class="list-group-item"><strong>Total:</strong> ${formatCurrency(payment.totalAmount ?? payment.amount ?? 0)}</li>
          <li class="list-group-item">
            <strong>Estado:</strong>
            <span class="ms-2 badge ${status.class}">${status.icon} ${status.label}</span>
          </li>
          <li class="list-group-item"><strong>Notas:</strong> ${payment.notes || "‚Äî"}</li>
          <li class="list-group-item"><small class="text-muted">ID: ${payment.id}</small></li>
        </ul>`;
      appState.detailsModal.show();
    }
    
    // --- INICIALIZACI√ìN DE EVENTOS ---

    document.addEventListener("DOMContentLoaded", () => {
      // Inicializar Modales de Bootstrap
      appState.formModal = new bootstrap.Modal(document.getElementById('formModal'));
      appState.detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
      appState.confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

      // Poner fecha de hoy por defecto
      const today = new Date(); 
      const yyyy = today.getFullYear(); 
      const mm = String(today.getMonth() + 1).padStart(2, '0'); 
      const dd = String(today.getDate()).padStart(2, '0');
      $('#date').value = `${yyyy}-${mm}-${dd}`;

      $('#quantity').addEventListener('input', calculateTotal);
      $('#unitPrice').addEventListener('input', calculateTotal);

      // Evento de env√≠o del formulario
      $('#payment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const pharmacy = $('#pharmacy').value.trim();
        const product = $('#product').value;
        const quantity = $('#quantity').value;
        const unitPrice = $('#unitPrice').value;
        const totalAmount = $('#total-value').value;
        const date = $('#date').value;
        const notes = $('#notes').value;
        const status = $('#status').value;

        if (pharmacy && product && quantity && unitPrice && totalAmount && date) {
          const payload = {
            pharmacy,
            product,
            quantity: Number(quantity),
            unitPrice: Number(unitPrice),
            totalAmount: Number(totalAmount),
            date: Timestamp.fromDate(new Date(date + "T00:00:00")),
            notes: notes || "",
            status: status || "pendiente"
          };
          
          const success = await addPayment(payload, e.submitter);

          if (success) {
            e.target.reset();
            $('#date').value = `${yyyy}-${mm}-${dd}`;
            $('#status').value = 'pendiente';
            $('#total-container').style.display = 'none';
            $('#total-value').value = '';
            appState.formModal.hide();
          }
        } else {
          showToast('‚ö†Ô∏è Por favor completa todos los campos requeridos', 'error');
        }
      });

      // Eventos de filtros
      $$('.refresh-btn').forEach(btn => btn.addEventListener('click', loadPayments));
      $('#filter-product').addEventListener('change', loadPayments);
      $('#filter-pharmacy').addEventListener('change', loadPayments);
      $('#filter-date').addEventListener('change', loadPayments);
      $('#filter-status').addEventListener('change', loadPayments);

      // Delegaci√≥n de eventos en la tabla
      $('#payments-table').addEventListener('click', (e) => {
        const btn = e.target.closest('button'); 
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (action === "delete") promptDeletePayment(id);
        if (action === "view") viewPayment(id);
        if (action === "toggle") togglePaymentStatus(id, btn.dataset.status);
      });

      // Botones para abrir modal de formulario
      $$('.js-open-form').forEach(btn => {
        btn.addEventListener('click', () => appState.formModal.show());
      });

      // Listener para el bot√≥n de confirmaci√≥n
      $('#confirm-modal-btn').addEventListener('click', confirmDeletePayment);

      // --- Listeners de GEMINI ---
      $('#gemini-summary-btn').addEventListener('click', handleGenerateSummary);
      $('#gemini-notes-btn').addEventListener('click', handleOptimizeNotes);
      $('#gemini-pharmacy-btn').addEventListener('click', handleFetchPharmacyInfo);

      // Iniciar la aplicaci√≥n
      initFirebase();
    });
  </script>
</head>
<body>
  <!-- Header -->
  <header class="app-header" role="banner">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1">
            <i class="fas fa-pills me-2" aria-hidden="true"></i>
            CRM Control de Pagos
          </h1>
          <p class="lead mb-0">Sistema profesional de gesti√≥n de medicamentos</p>
        </div>
        <div class="text-end">
          <span id="user-id-display" title="ID de usuario autenticado">Cargando...</span>
        </div>
      </div>
    </div>
  </header>

  <main class="container my-4" role="main">
    <!-- Presupuesto + KPIs -->
    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <div class="card budget-card">
          <div class="card-header">
            <i class="fas fa-wallet me-2" aria-hidden="true"></i>Control de Presupuesto
          </div>
          <div class="card-body position-relative">
            <div class="row text-center">
              <div class="col-6">
                <div class="number" id="total-pagado" aria-label="Total pagado">$0</div>
                <div class="label">Total Pagado</div>
              </div>
              <div class="col-6">
                <div class="number" id="presupuesto-restante" aria-label="Presupuesto restante">$500,000</div>
                <div class="label">Restante</div>
              </div>
            </div>
            <div class="budget-info">
              <div class="d-flex justify-content-between mb-2">
                <span>Progreso</span>
                <strong id="porcentaje-usado">0%</strong>
              </div>
              <div class="progress" role="progressbar" aria-label="Progreso del presupuesto" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <div id="budget-progress" class="progress-bar bg-success" style="width:0%"></div>
              </div>
              <small class="text-light mt-2 d-block">Presupuesto total: $500,000 COP</small>
            </div>
            <div id="budget-alert" class="alert mt-3" role="alert" style="display:none;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border:0">
              <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>
              <strong>¬°Presupuesto excedido!</strong> Superado por: <span id="exceso-presupuesto">$0</span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="row g-3">
          <div class="col-4">
            <div class="card stats-card">
              <i class="fas fa-snowflake stat-icon-bg" aria-hidden="true"></i>
              <div class="number" id="total-descongel">0</div>
              <div class="label">Descongel x100</div>
            </div>
          </div>
          <div class="col-4">
            <div class="card stats-card">
              <i class="fas fa-capsules stat-icon-bg" aria-hidden="true"></i>
              <div class="number" id="total-multidol400">0</div>
              <div class="label">Multidol 400mg</div>
            </div>
          </div>
          <div class="col-4">
            <div class="card stats-card">
              <i class="fas fa-pills stat-icon-bg" aria-hidden="true"></i>
              <div class="number" id="total-multidol800">0</div>
              <div class="label">Multidol 800mg</div>
            </div>
          </div>
          <div class="col-6">
            <div class="card stats-card status-stats warning-stat">
              <i class="fas fa-clock stat-icon-bg" style="color:rgba(255,255,255,0.2)" aria-hidden="true"></i>
              <div class="number" id="total-pendientes">0</div>
              <div class="label">‚è≥ Pendientes</div>
            </div>
          </div>
          <div class="col-6">
            <div class="card stats-card status-stats success-stat">
              <i class="fas fa-check-circle stat-icon-bg" style="color:rgba(255,255,255,0.2)" aria-hidden="true"></i>
              <div class="number" id="total-procesados">0</div>
              <div class="label">‚úÖ Procesados</div>
            </div>
          </div>
          <div class="col-12">
            <div class="card stats-card">
              <i class="fas fa-file-invoice-dollar stat-icon-bg" aria-hidden="true"></i>
              <div class="number" id="total-pagos">0</div>
              <div class="label">Total Pagos</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros y An√°lisis IA -->
    <div class="row g-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <i class="fas fa-filter me-2" aria-hidden="true"></i>Filtros
            </div>
            <button class="btn btn-sm btn-light refresh-btn" aria-label="Actualizar datos">
              <i class="fas fa-rotate me-1" aria-hidden="true"></i> 
              <span class="d-none d-md-inline">Actualizar</span>
            </button>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-product">
                  <i class="fas fa-box me-1" aria-hidden="true"></i> Producto
                </label>
                <select id="filter-product" class="form-select" aria-label="Filtrar por producto">
                  <option value="">Todos</option>
                  <option value="descongel">Descongel x100 c√°psulas</option>
                  <option value="multidol400">Multidol 400mg</option>
                  <option value="multidol800">Multidol 800mg</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-pharmacy">
                  <i class="fas fa-store me-1" aria-hidden="true"></i> Farmacia
                </label>
                <select id="filter-pharmacy" class="form-select" aria-label="Filtrar por farmacia">
                  <option value="">Todas</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-status">
                  <i class="fas fa-tag me-1" aria-hidden="true"></i> Estado
                </label>
                <select id="filter-status" class="form-select" aria-label="Filtrar por estado">
                  <option value="">Todos</option>
                  <option value="pendiente">‚è≥ Pendiente</option>
                  <option value="procesado">‚úÖ Procesado</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-date">
                  <i class="fas fa-calendar me-1" aria-hidden="true"></i> Mes
                </label>
                <input id="filter-date" type="month" class="form-control" aria-label="Filtrar por mes"/>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- NUEVO: Tarjeta de An√°lisis con IA -->
      <div class="col-12">
        <div class="card">
          <div class="card-header gemini-card-header">
            <i class="fas fa-magic me-2" aria-hidden="true"></i>An√°lisis con IA
          </div>
          <div class="card-body">
            <p class="text-muted">Obtenga un resumen de la situaci√≥n actual basado en los KPIs y filtros seleccionados.</p>
            <button id="gemini-summary-btn" class="btn btn-primary">
              ‚ú® Generar Resumen Ejecutivo
            </button>
            <div id="gemini-summary-loader" style="display:none;" class="mt-3 gemini-loader">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              Analizando datos...
            </div>
            <div id="gemini-summary-result" class="mt-3 gemini-result" style="display:none;"></div>
          </div>
        </div>
      </div>

      <!-- Historial -->
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-list me-2" aria-hidden="true"></i>Historial de Pagos
          </div>
          <div class="card-body">
            <div class="table-responsive table-wrap">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th scope="col">Fecha</th>
                    <th scope="col">Farmacia</th>
                    <th scope="col">Producto</th>
                    <th scope="col">Cant.</th>
                    <th scope="col">Valor Unit.</th>
                    <th scope="col">Total</th>
                    <th scope="col">Estado</th>
                    <th scope="col">Descripci√≥n</th>
                    <th scope="col">Acciones</th>
                  </tr>
                </thead>
                <tbody id="payments-table">
                  <!-- El contenido se carga din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Botones m√≥vil -->
    <div class="d-md-none d-flex gap-2 mt-3">
      <button class="btn btn-primary flex-fill js-open-form">
        <i class="fa fa-plus me-2" aria-hidden="true"></i>Registrar pago
      </button>
      <button class="btn btn-outline-light flex-fill refresh-btn">
        <i class="fa fa-rotate me-2" aria-hidden="true"></i>Actualizar
      </button>
    </div>
  </main>

  <!-- Modal: Registrar Pago -->
  <div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="card-header" id="formModalTitle">
          <i class="fas fa-plus-circle me-2" aria-hidden="true"></i>Registrar Nuevo Pago
        </div>
        <div class="modal-body p-4">
          <form id="payment-form">
            <div class="mb-3">
              <label class="form-label" for="pharmacy">
                <i class="fas fa-store me-1" aria-hidden="true"></i> Nombre de Farmacia
              </label>
              <!-- NUEVO: Grupo de input para bot√≥n de IA -->
              <div class="input-group">
                <input id="pharmacy" type="text" class="form-control" required placeholder="Ej: Droguer√≠a Bucaramanga" aria-required="true"/>
                <button class="btn btn-outline-secondary" type="button" id="gemini-pharmacy-btn" title="Buscar informaci√≥n de la farmacia">
                  ‚ú® Info
                </button>
              </div>
              <div id="gemini-pharmacy-loader" style="display:none;" class="form-text gemini-loader mt-2">
                 <div class="spinner-border spinner-border-sm" role="status"></div>
                 Buscando...
              </div>
              <div id="gemini-pharmacy-result" class="form-text text-primary fw-bold" style="display:none;"></div>
            </div>
            
            <div class="mb-3">
              <label class="form-label" for="product">
                <i class="fas fa-box me-1" aria-hidden="true"></i> Producto
              </label>
              <select id="product" class="form-select" required aria-required="true">
                <option value="">Seleccionar producto</option>
                <option value="descongel">Descongel x100 c√°psulas</option>
                <option value="multidol400">Multidol 400mg</option>
                <option value="multidol800">Multidol 800mg</option>
              </select>
            </div>
            <div class="row g-3">
              <div class="col-6">
                <label class="form-label" for="quantity">
                  <i class="fas fa-hashtag me-1" aria-hidden="true"></i> Cantidad
                </label>
                <input id="quantity" type="number" inputmode="numeric" min="1" step="1" class="form-control" required placeholder="Ej: 5" aria-required="true"/>
              </div>
              <div class="col-6">
                <label class="form-label" for="unitPrice">
                  <i class="fas fa-dollar-sign me-1" aria-hidden="true"></i> Valor Unit.
                </label>
                <input id="unitPrice" type="number" inputmode="numeric" min="0" step="100" class="form-control" required placeholder="Ej: 5000" aria-required="true"/>
              </div>
            </div>

            <div id="total-container" class="mt-3" style="display:none">
              <div class="alert d-flex align-items-center mb-0" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:0;border-radius:var(--radius-lg);padding:1.25rem">
                <div class="me-3" style="font-size:2rem">
                  <i class="fa-solid fa-sack-dollar" aria-hidden="true"></i>
                </div>
                <div>
                  <div class="small">Total a pagar</div>
                  <div id="total-display" class="fw-bold fs-4">$0</div>
                </div>
              </div>
              <input type="hidden" id="total-value" value="">
            </div>

            <div class="row g-3 mt-2">
              <div class="col-6">
                <label class="form-label" for="status">
                  <i class="fas fa-tag me-1" aria-hidden="true"></i> Estado
                </label>
                <select id="status" class="form-select" required aria-required="true">
                  <option value="pendiente">‚è≥ Pendiente</option>
                  <option value="procesado">‚úÖ Procesado</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label" for="date">
                  <i class="fas fa-calendar me-1" aria-hidden="true"></i> Fecha
                </label>
                <input id="date" type="date" class="form-control" required aria-required="true"/>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label" for="notes">
                <i class="fas fa-sticky-note me-1" aria-hidden="true"></i> Descripci√≥n/Notas
              </label>
              <textarea id="notes" rows="3" class="form-control" placeholder="Ej: Pago correspondiente a agosto"></textarea>
              <!-- NUEVO: Bot√≥n para optimizar nota -->
              <button class="btn btn-sm btn-outline-primary mt-2" type="button" id="gemini-notes-btn">
                ‚ú® Optimizar Nota
              </button>
              <div id="gemini-notes-loader" style="display:none;" class="form-text gemini-loader mt-2">
                 <div class="spinner-border spinner-border-sm" role="status"></div>
                 Optimizando...
              </div>
            </div>

            <div class="d-grid gap-2 mt-4">
              <button class="btn btn-primary btn-lg" type="submit">
                <i class="fas fa-save me-2" aria-hidden="true"></i>Guardar Pago
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Detalles -->
  <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="card-header">
          <span id="detailsTitle">Detalles del Pago</span>
        </div>
        <div class="modal-body p-4" id="detailsBody"></div>
        <div class="p-4 pt-0 text-end">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Confirmar Eliminaci√≥n -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" id="confirmModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Confirmar Acci√≥n
        </div>
        <div class="modal-body" id="confirm-modal-body">
          ¬øEst√° seguro?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirm-modal-btn">
            <i class="fas fa-trash me-2"></i>Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>


  <footer class="text-center" role="contentinfo">
    <strong>CRM Control de Pagos</strong> ¬© 2025 ‚Äî Sistema profesional de gesti√≥n
  </footer>

  <!-- FAB Button -->
  <button class="btn btn-primary fab-button position-fixed d-none d-md-inline-flex align-items-center justify-content-center js-open-form"
          style="right:24px;bottom:24px;border-radius:50%;width:64px;height:64px" 
          title="Registrar nuevo pago"
          aria-label="Registrar nuevo pago">
    <i class="fa fa-plus" style="font-size:1.5rem" aria-hidden="true"></i>
  </button>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
