<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM Control de Pagos - Consolidado</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --primary:#2c3e50; --secondary:#3498db; --success:#27ae60;
      --warning:#f39c12; --danger:#e74c3c; --light:#ecf0f1; --dark:#34495e;
    }
    html,body{background:#f8f9fa;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif;}
    .app-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:1rem 0 1.25rem;box-shadow:0 2px 8px rgba(0,0,0,.12);position:sticky;top:0;z-index:20}
    .app-header .lead{opacity:.95}
    .card{border:0;border-radius:14px;box-shadow:0 6px 16px rgba(15,23,42,.06)}
    .card-header{border:0;border-radius:14px 14px 0 0;background:var(--primary);color:#fff;font-weight:600}
    .stats-card{padding:1rem;text-align:center}
    .stats-card .number{font-size:1.8rem;font-weight:800;color:var(--primary)}
    .budget-card{background:linear-gradient(135deg,#2c3e50,#3f5370);color:#fff}
    .budget-card .number{color:#fff}
    .budget-info{background:rgba(255,255,255,.12);border-radius:10px;padding:.8rem;margin-top:.75rem}
    .badge-descongel{background:#3498db}
    .badge-multidol400{background:#2ecc71}
    .badge-multidol800{background:#9b59b6}
    .status-toggle-btn{border:none !important;border-radius:20px;padding:.35rem .7rem;font-size:.85rem}
    .status-stats{background:linear-gradient(135deg,#8e44ad,#9b59b6);color:#fff}
    .toast-notification{position:fixed;top:16px;right:16px;background:#27ae60;color:#fff;padding:.9rem 1.1rem;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.18);z-index:2000;transition:opacity .3s}
    .toast-error{background:#e74c3c}
    .loading-skeleton{height:12px;background:linear-gradient(90deg,#eee 25%,#f5f5f5 37%,#eee 63%);background-size:400% 100%;animation:skeleton 1.4s ease infinite;border-radius:6px}
    @keyframes skeleton{0%{background-position:100% 0}100%{background-position:0 0}}
    .table-wrap{width:100%}
    @media (max-width: 768px){
      .table thead{display:none}
      .table tbody tr{display:block;background:#fff;border-radius:12px;margin-bottom:.75rem;box-shadow:0 4px 14px rgba(0,0,0,.06)}
      .table tbody td{display:flex;justify-content:space-between;gap:12px;padding:.75rem 1rem;border-bottom:1px dashed #eee}
      .table tbody td:last-child{border-bottom:0}
      .table tbody td::before{content:attr(data-label);font-weight:600;color:#6b7280}
      .action-buttons .btn{min-width:40px}
    }
    .modal-content{border:0;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.22)}
    .form-control,.form-select{min-height:46px;font-size:16px}
    .btn{min-height:44px}
    .table-hover>tbody>tr:hover>*{background:rgba(52,152,219,.04)}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, updateDoc, setDoc, increment, getDoc, collectionGroup
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // TUS DATOS CORRECTOS DE FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyB2glK3jtje7juBG7gMl4bzh6xG_Zz2YNU",
      authDomain: "crm-farmacias.firebaseapp.com",
      projectId: "crm-farmacias",
      storageBucket: "crm-farmacias.firebasestorage.app",
      messagingSenderId: "251276216502",
      appId: "1:251276216502:web:374f708e2ff040192d3e17"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const BUDGET_TOTAL = 500000;
    let totalLegalizado = 0;
    let allPharmacies = [];
    let allPaymentsCache = [];

    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    const PRODUCTS = {
      descongel:{name:"Descongel x100 c√°psulas", cls:"descongel", icon:"‚ùÑÔ∏è"},
      multidol400:{name:"Multidol 400mg", cls:"multidol400", icon:"üíä"},
      multidol800:{name:"Multidol 800mg", cls:"multidol800", icon:"üíä"}
    };
    function getProductName(k){return (PRODUCTS[k]?.name)||k}
    function getProductClass(k){return (PRODUCTS[k]?.cls)||""}
    function getProductIcon(k){return (PRODUCTS[k]?.icon)||"üì¶"}
    function getPaymentStatus(s){
      const map={
        pendiente:{label:"Pendiente", class:"bg-warning text-dark", icon:"‚è≥"},
        procesado:{label:"Procesado", class:"bg-success text-white", icon:"‚úÖ"}
      };return map[s]||map.pendiente
    }
    function toDate(d){
      if(d instanceof Date) return d;
      if(d?.toDate) return d.toDate();
      if(typeof d==="string") return new Date(d+"T00:00:00");
      return new Date(d);
    }
    function formatDate(d){
      const dt = toDate(d);
      return dt.toLocaleDateString("es-CO",{year:"numeric",month:"short",day:"numeric"});
    }
    function formatCurrency(v){
      const n = Number(v||0);
      return new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
    }
    function showToast(msg,type="success"){
      const id="toast-"+Date.now();
      const icon = type==="success" ? "check-circle" : "exclamation-circle";
      const el = document.createElement("div");
      el.id=id;
      el.className=`toast-notification ${type==="error"?"toast-error":""}`;
      el.innerHTML=`<i class="fas fa-${icon} me-2"></i>${msg}`;
      document.body.appendChild(el);
      setTimeout(()=>{el.style.opacity="0"; setTimeout(()=>el.remove(),300)},3000);
    }
    function spinnerRow(){
      return `
        <tr>
          <td colspan="9">
            <div class="p-3">
              <div class="loading-skeleton mb-2" style="height:16px;width:35%"></div>
              <div class="loading-skeleton mb-2" style="height:12px;width:80%"></div>
              <div class="loading-skeleton" style="height:12px;width:55%"></div>
            </div>
          </td>
        </tr>`;
    }

    function calculateTotal(){
      const q = Number($('#quantity').value||0);
      const up = Number($('#unitPrice').value||0);
      const total = q*up;
      $('#total-display').textContent = formatCurrency(total);
      $('#total-value').value = String(total);
      $('#total-container').style.display = (q>0 && up>0) ? 'block' : 'none';
    }

    async function loadAllData(){
      const tbody = $('#payments-table');
      tbody.innerHTML = spinnerRow();

      try {
        // CORRECCI√ìN: Usar "pharmacies" en lugar de "pharmacies"
        const pharmaciesSnap = await getDocs(query(collection(db, "pharmacies"), orderBy("nombre")));
        allPharmacies = pharmaciesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        const pharmacyNameMap = new Map(allPharmacies.map(p => [p.id, p.nombre]));
        populatePharmacyFilters();

        const paymentsQuery = query(collectionGroup(db, 'payments'), orderBy('date', 'desc'));
        const paymentsSnap = await getDocs(paymentsQuery);
        
        allPaymentsCache = paymentsSnap.docs.map(doc => {
            const pharmacyId = doc.ref.parent.parent.id;
            return {
                id: doc.id,
                pharmacyId: pharmacyId,
                pharmacyName: pharmacyNameMap.get(pharmacyId) || 'Desconocida',
                ...doc.data()
            };
        });

        const legalizadoDoc = await getDoc(doc(db, "budget_meta", "main"));
        totalLegalizado = legalizadoDoc.exists() ? legalizadoDoc.data().total : 0;

        filterAndRender();

      } catch (e) {
        console.error("Error al cargar datos:", e);
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger py-4">Error al cargar datos. Revisa la consola.</td></tr>`;
        if (String(e.message).includes("indexes?create_composite")) {
            showIndexHelp(String(e.message).match(/https:\/\/console\.firebase\.google\.com\/[^\s]+/)[0]);
        }
      }
    }
    
    function filterAndRender() {
        const pf = $('#filter-product').value || "";
        const phf = $('#filter-pharmacy').value || "";
        const df = $('#filter-date').value || "";
        const sf = $('#filter-status').value || "";

        const filteredPayments = allPaymentsCache.filter(p => {
            const date = toDate(p.date);
            const monthMatch = df ? (date.getFullYear() === new Date(df + '-02').getFullYear() && date.getMonth() === new Date(df + '-02').getMonth()) : true;
            const productMatch = pf ? p.product === pf : true;
            const pharmacyMatch = phf ? p.pharmacyId === phf : true;
            const statusMatch = sf ? (p.status || 'pendiente') === sf : true;
            return monthMatch && productMatch && pharmacyMatch && statusMatch;
        });
        
        renderPayments(filteredPayments);
    }

    function populatePharmacyFilters() {
        const sel = $('#filter-pharmacy');
        const formSel = $('#pharmacy');
        sel.innerHTML = '<option value="">Todas</option>';
        formSel.innerHTML = '<option value="">Seleccionar farmacia</option>';

        allPharmacies.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.nombre;
            sel.appendChild(opt.cloneNode(true));
            formSel.appendChild(opt);
        });
    }

    function renderPayments(payments){
      const tbody = $('#payments-table');
      tbody.innerHTML = "";

      payments.forEach(p=>{
        const st = getPaymentStatus(p.status || 'pendiente');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Fecha">${formatDate(p.date)}</td>
          <td data-label="Farmacia"><strong>${p.pharmacyName || "-"}</strong></td>
          <td data-label="Producto">
            <span class="me-1">${getProductIcon(p.product)}</span>
            <span class="badge badge-${getProductClass(p.product)}">${getProductName(p.product)}</span>
          </td>
          <td data-label="Cant."><strong>${p.quantity||1}</strong></td>
          <td data-label="Valor Unit.">${formatCurrency(p.unitPrice)}</td>
          <td data-label="Total"><strong>${formatCurrency(p.totalAmount)}</strong></td>
          <td data-label="Estado" class="text-center">
            <button class="btn btn-sm status-toggle-btn ${st.class}" data-action="toggle" data-id="${p.id}" data-pharmacy-id="${p.pharmacyId}" data-status="${p.status || 'pendiente'}" title="Cambiar estado">
              ${st.icon} ${st.label}
            </button>
          </td>
          <td data-label="Descripci√≥n">
            <small class="text-muted">${p.notes ? (p.notes.length>60 ? p.notes.slice(0,60)+"‚Ä¶" : p.notes) : "Sin descripci√≥n"}</small>
          </td>
          <td data-label="Acciones" class="action-buttons">
            <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${p.id}" data-pharmacy-id="${p.pharmacyId}" title="Eliminar">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      if(payments.length===0){
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4"><i class="fa-regular fa-folder-open me-2"></i>No se encontraron pagos con los filtros aplicados.</td></tr>`;
      }
      updateStats(payments, totalLegalizado);
    }

    function updateStats(payments, legalizado){
      const totalBruto = payments.reduce((s,p)=> s + Number(p.totalAmount||0), 0);
      const totalNeto = totalBruto - legalizado;
      const restante = BUDGET_TOTAL - totalNeto;
      const pct = (totalNeto/BUDGET_TOTAL)*100;

      $('#total-pagado').textContent = formatCurrency(totalNeto);
      $('#total-legalizado').textContent = formatCurrency(legalizado);
      $('#presupuesto-restante').textContent = formatCurrency(restante);
      $('#porcentaje-usado').textContent = `${isFinite(pct)?pct.toFixed(1):0}%`;

      const bar = $('#budget-progress');
      bar.style.width = `${Math.max(0, Math.min(pct,100))}%`;
      bar.className = 'progress-bar';
      if(pct>=90) bar.classList.add('bg-danger');
      else if(pct>=75) bar.classList.add('bg-warning');
      else bar.classList.add('bg-success');

      const alert = $('#budget-alert');
      if(totalNeto > BUDGET_TOTAL){
        alert.style.display='block';
        $('#exceso-presupuesto').textContent = formatCurrency(totalNeto - BUDGET_TOTAL);
      }else{
        alert.style.display='none';
      }
    }

    async function addPayment(pharmacyId, pharmacyName, product, quantity, unitPrice, totalAmount, date, notes, status){
      try{
        const payload = {
          pharmacyName,
          product,
          quantity:Number(quantity),
          unitPrice:Number(unitPrice),
          totalAmount:Number(totalAmount),
          date:new Date(date+"T00:00:00"),
          notes:notes||"",
          status:status||"pendiente"
        };
        // CORRECCI√ìN: Usar "pharmacies" en lugar de "pharmacies"
        await addDoc(collection(db, `pharmacies/${pharmacyId}/payments`), payload);
        await loadAllData();
        showToast(`‚úÖ Pago registrado en ${pharmacyName}.`,"success");
      }catch(e){
        console.error(e); showToast("‚ùå Error al registrar el pago.","error");
      }
    }

    async function deletePayment(pharmacyId, paymentId){
      if(!confirm("¬øEst√° seguro de eliminar este pago?")) return;
      try{
        // CORRECCI√ìN: Usar "pharmacies" en lugar de "pharmacies"
        await deleteDoc(doc(db, `pharmacies/${pharmacyId}/payments`, paymentId));
        await loadAllData();
        showToast("üóëÔ∏è Pago eliminado correctamente","success");
      }catch(e){
        console.error(e); showToast("‚ùå Error al eliminar el pago","error");
      }
    }

    async function togglePaymentStatus(pharmacyId, paymentId, currentStatus){
      const next = currentStatus==="pendiente" ? "procesado" : "pendiente";
      try{
        // CORRECCI√ìN: Usar "pharmacies" en lugar de "pharmacies"
        await updateDoc(doc(db, `pharmacies/${pharmacyId}/payments`, paymentId), {status:next});
        const info=getPaymentStatus(next);
        showToast(`${info.icon} Estado cambiado a: ${info.label}`,"success");
        await loadAllData();
      }catch(e){
        console.error(e); showToast("‚ùå Error al cambiar el estado","error");
      }
    }
    
    async function legalizarMonto(amount) {
      const parsedAmount = Number(amount);
      if (!parsedAmount || parsedAmount <= 0) {
        showToast("El monto a legalizar debe ser un n√∫mero mayor a cero.", "error");
        return;
      }
      const docRef = doc(db, "budget_meta", "main");
      try {
        await updateDoc(docRef, { total: increment(parsedAmount) });
        showToast(`‚úÖ ${formatCurrency(parsedAmount)} legalizados.`, "success");
        await loadAllData();
      } catch (e) {
        if (e.code === 'not-found') {
          await setDoc(docRef, { total: parsedAmount });
          showToast(`‚úÖ ${formatCurrency(parsedAmount)} legalizados.`, "success");
          await loadAllData();
        } else {
          console.error("Error al legalizar:", e);
          showToast("‚ùå Error al procesar la legalizaci√≥n.", "error");
        }
      }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      const today = new Date(); const yyyy=today.getFullYear(); const mm=String(today.getMonth()+1).padStart(2,'0'); const dd=String(today.getDate()).padStart(2,'0');
      $('#date').value = `${yyyy}-${mm}-${dd}`;

      $('#quantity').addEventListener('input', calculateTotal);
      $('#unitPrice').addEventListener('input', calculateTotal);

      $('#payment-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        const selectedPharmacy = $('#pharmacy');
        const pharmacyId = selectedPharmacy.value;
        const pharmacyName = selectedPharmacy.options[selectedPharmacy.selectedIndex].text;

        if (!pharmacyId) {
            showToast('‚ö†Ô∏è Por favor, seleccione una farmacia.', 'error');
            return;
        }

        const product=$('#product').value;
        const quantity=$('#quantity').value;
        const unitPrice=$('#unitPrice').value;
        const totalAmount=$('#total-value').value;
        const date=$('#date').value;
        const notes=$('#notes').value;
        const status=$('#status').value;

        if(product && quantity && unitPrice && totalAmount && date){
          addPayment(pharmacyId, pharmacyName, product, quantity, unitPrice, totalAmount, date, notes, status);
          e.target.reset();
          $('#date').value = `${yyyy}-${mm}-${dd}`;
          $('#status').value = 'pendiente';
          $('#total-container').style.display='none';
          $('#total-value').value='';

          const formModalEl = document.getElementById('formModal');
          const formModal = bootstrap.Modal.getOrCreateInstance(formModalEl);
          formModal.hide();
        }else{
          showToast('‚ö†Ô∏è Por favor completa todos los campos requeridos','error');
        }
      });

      $('#legalizar-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const amount = $('#legalizar-amount').value;
        await legalizarMonto(amount);
        
        $('#legalizar-amount').value = '';
        const legalizarModalEl = document.getElementById('legalizarModal');
        const legalizarModal = bootstrap.Modal.getOrCreateInstance(legalizarModalEl);
        legalizarModal.hide();
      });

      $$('.filter-control').forEach(el => el.addEventListener('change', filterAndRender));

      $('#payments-table').addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const action = btn.dataset.action;
        const paymentId = btn.dataset.id;
        const pharmacyId = btn.dataset.pharmacyId;
        if(action==="delete") deletePayment(pharmacyId, paymentId);
        if(action==="toggle") togglePaymentStatus(pharmacyId, paymentId, btn.dataset.status);
      });

      $$('.js-open-form').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const m = new bootstrap.Modal(document.getElementById('formModal'));
          m.show();
        });
      });
      $('#open-legalizar-modal').addEventListener('click', () => {
        const m = new bootstrap.Modal(document.getElementById('legalizarModal'));
        m.show();
      });

      loadAllData();
    });
  </script>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="container">
      <h1 class="h4 mb-1"><i class="fas fa-pills me-2"></i>CRM Control de Pagos</h1>
      <p class="lead mb-0">Vista consolidada de todas las farmacias</p>
    </div>
  </header>

  <main class="container my-3">
    <!-- Presupuesto + KPIs -->
    <div class="row g-3 mb-2">
      <div class="col-lg-6">
        <div class="card budget-card">
          <div class="card-header"><i class="fas fa-wallet me-2"></i>Control de Presupuesto Global</div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-6">
                <div class="number" id="total-pagado">$0</div>
                <div id="total-pagado-label">Total Pagado (Neto)</div>
              </div>
              <div class="col-6">
                <div class="number" id="presupuesto-restante">$500,000</div>
                <div>Presupuesto Restante</div>
              </div>
            </div>
            <div class="budget-info">
              <div class="d-flex justify-content-between mb-2">
                <span>Progreso</span><strong id="porcentaje-usado">0%</strong>
              </div>
              <div class="progress" role="progressbar" aria-label="Progreso de presupuesto">
                <div id="budget-progress" class="progress-bar bg-success" style="width:0%"></div>
              </div>
              <div class="d-flex justify-content-between mt-1">
                <small class="text-light">Presupuesto total: $500,000 COP</small>
                <small class="text-light">Legalizado: <strong id="total-legalizado">$0</strong></small>
              </div>
            </div>
            <div id="budget-alert" class="alert mt-3" style="display:none;background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;border:0;border-radius:10px">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>¬°Presupuesto excedido!</strong> Superado por: <span id="exceso-presupuesto">$0</span>
            </div>
            <div class="d-grid mt-3">
              <button id="open-legalizar-modal" class="btn btn-info"><i class="fas fa-check-double me-2"></i>Legalizar Gasto</button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header"><i class="fas fa-chart-pie me-2"></i>Estad√≠sticas Globales</div>
            <div class="card-body d-flex align-items-center justify-content-center text-muted">
                <p>Aqu√≠ se mostrar√°n las estad√≠sticas consolidadas.</p>
            </div>
        </div>
      </div>
    </div>

    <!-- Filtros + Historial -->
    <div class="row g-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div><i class="fas fa-filter me-2"></i>Filtros</div>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-product">Producto</label>
                <select id="filter-product" class="form-select filter-control">
                  <option value="">Todos</option>
                  <option value="descongel">Descongel x100 c√°psulas</option>
                  <option value="multidol400">Multidol 400mg</option>
                  <option value="multidol800">Multidol 800mg</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-pharmacy">Farmacia</label>
                <select id="filter-pharmacy" class="form-select filter-control">
                  <option value="">Todas</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-status">Estado</label>
                <select id="filter-status" class="form-select filter-control">
                  <option value="">Todos</option>
                  <option value="pendiente">‚è≥ Pendiente</option>
                  <option value="procesado">‚úÖ Procesado</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-date">Mes</label>
                <input id="filter-date" type="month" class="form-control filter-control"/>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Historial -->
      <div class="col-12">
        <div class="card">
          <div class="card-header"><i class="fas fa-list me-2"></i>Historial de Pagos Consolidado</div>
          <div class="card-body">
            <div class="table-responsive table-wrap">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Fecha</th><th>Farmacia</th><th>Producto</th><th>Cant.</th>
                    <th>Valor Unit.</th><th>Total</th><th>Estado</th><th>Descripci√≥n</th><th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="payments-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n R√°pida (m√≥vil) -->
    <div class="d-md-none d-flex gap-2 mt-2">
      <button class="btn btn-primary flex-fill js-open-form"><i class="fa fa-plus me-2"></i>Registrar pago</button>
    </div>
  </main>

  <!-- Modal: Registrar Pago -->
  <div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="card-header" id="formModalTitle"><i class="fas fa-plus-circle me-2"></i>Registrar Nuevo Pago</div>
        <div class="modal-body">
          <form id="payment-form">
            <div class="mb-3">
              <label class="form-label" for="pharmacy">Farmacia</label>
              <select id="pharmacy" class="form-select" required>
                <option value="">Seleccionar farmacia</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="product">Producto</label>
              <select id="product" class="form-select" required>
                <option value="">Seleccionar producto</option>
                <option value="descongel">Descongel x100 c√°psulas</option>
                <option value="multidol400">Multidol 400mg</option>
                <option value="multidol800">Multidol 800mg</option>
              </select>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label" for="quantity">Cantidad</label>
                <input id="quantity" type="number" inputmode="numeric" min="1" step="1" class="form-control" required placeholder="Ej: 5"/>
              </div>
              <div class="col-6">
                <label class="form-label" for="unitPrice">Valor Unit. (COP)</label>
                <input id="unitPrice" type="number" inputmode="numeric" min="0" step="100" class="form-control" required placeholder="Ej: 5000"/>
              </div>
            </div>

            <div id="total-container" class="mt-3" style="display:none">
              <div class="alert d-flex align-items-center mb-0" style="background:linear-gradient(135deg,#27ae60,#1f8e4e);color:#fff;border:0">
                <div class="me-3"><i class="fa-solid fa-sack-dollar"></i></div>
                <div>
                  <div class="small">Total a pagar</div>
                  <div id="total-display" class="fw-bold fs-5">$0</div>
                </div>
              </div>
              <input type="hidden" id="total-value" value="">
            </div>

            <div class="row g-2 mt-2">
              <div class="col-6">
                <label class="form-label" for="status">Estado</label>
                <select id="status" class="form-select" required>
                  <option value="pendiente">‚è≥ Pendiente</option>
                  <option value="procesado">‚úÖ Procesado</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label" for="date">Fecha</label>
                <input id="date" type="date" class="form-control" required />
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label" for="notes">Descripci√≥n/Notas</label>
              <textarea id="notes" rows="2" class="form-control" placeholder="Ej: Pago correspondiente a agosto"></textarea>
            </div>

            <div class="d-grid mt-3">
              <button class="btn btn-primary" type="submit"><i class="fas fa-save me-2"></i>Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Legalizar Gasto -->
  <div class="modal fade" id="legalizarModal" tabindex="-1" aria-labelledby="legalizarModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="card-header" id="legalizarModalTitle"><i class="fas fa-check-double me-2"></i>Legalizar Gasto</div>
        <div class="modal-body">
          <p class="text-muted">Ingresa el monto total que ya ha sido legalizado. Este valor se restar√° del total pagado, liberando presupuesto.</p>
          <form id="legalizar-form">
            <div class="mb-3">
              <label class="form-label" for="legalizar-amount">Monto a Legalizar (COP)</label>
              <input id="legalizar-amount" type="number" inputmode="numeric" min="1" step="1" class="form-control" required placeholder="Ej: 150000"/>
            </div>
            <div class="d-grid">
              <button class="btn btn-success" type="submit"><i class="fas fa-save me-2"></i>Guardar Legalizaci√≥n</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center py-3 text-muted">
    CRM Control de Pagos &copy; 2025
  </footer>

  <!-- Bot√≥n flotante (desktop/tablet) -->
  <button class="btn btn-primary position-fixed d-none d-md-inline-flex align-items-center justify-content-center js-open-form"
          style="right:18px;bottom:22px;border-radius:28px;width:56px;height:56px" title="Registrar pago">
    <i class="fa fa-plus"></i>
  </button>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
