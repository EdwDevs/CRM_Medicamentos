<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Control de Pagos - Medicamentos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .header {
            background: linear-gradient(90deg, #007bffad 0%, #37b37e 100%);
            color: white;
            padding: 2rem 0 1rem 0;
            margin-bottom: 1rem;
            box-shadow: 0px 2px 8px #0096883a;
        }
        .budget-card {
            box-shadow: 0px 2px 8px #27ae607a;
            border: none;
            background: #2196f314;
        }
        .budget-info {
            margin: 1.2rem 0 0.5rem 0;
        }
        .budget-progress {
            height: 11px;
            border-radius: 6px;
        }
        .budget-alert {
            margin-top: 1rem;
            color: #fff;
            background: #ee303070;
            font-size: .98rem;
        }
        .stats-card {
            background: #fff;
            text-align: center;
            padding: 1.1rem 0.6rem;
            border-radius: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            box-shadow: 0 1px 6px #2196f326;
        }
        .stats-card .number {
            color: #0d6efd;
            font-size: 1.5rem;
            margin-bottom: .2rem;
        }
        .stats-card .label {
            font-size: .94rem;
            color: #444;
        }
        .status-stats .number { color: #f39c12; }
        .status-stats:last-child .number { color: #198754; }
        .filter-section { margin-bottom: 1rem; }
        .total-display { font-size: 1.15rem; text-align: center; margin: .6rem 0; }
        .btn-floating {
            border-radius: 40px;
            padding: 0.7em 1.5em;
            font-size: 1.1em;
            box-shadow: 0 4px 14px #05c46b2e;
        }
        .footer {
            padding: 1.1rem 0 0.4rem 0;
            background: #222;
            color: #fff;
            font-size: .96rem;
            margin-top: 2rem;
        }
        @media (max-width: 991px) {
            .header h1 { font-size: 1.7rem; }
            .budget-card, .stats-card { margin-bottom: 1.1rem; }
            .footer { font-size: .87rem; }
        }
        @media (max-width: 600px) {
            .header { padding: 1.2rem 0 .7rem 0;}
            .header h1 { font-size: 1.2rem;}
            .filter-section { font-size: .94rem;}
            .container { padding: 0 2px;}
            .btn-floating {bottom:15px;right:10px;padding:0.5em 1.2em;}
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <div class="container">
            <h1><i class="fas fa-pills me-2"></i>CRM Control de Pagos</h1>
            <p class="lead mb-1">Gesti√≥n de pagos para Cajas de Descongel x100 c√°psulas, Multidol x400mg y 800mg</p>
        </div>
    </div>

    <div class="container">
        <!-- PANEL DE PRESUPUESTO Y ESTAD√çSTICAS -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card budget-card">
                    <div class="card-header">
                        <i class="fas fa-wallet me-2"></i>Control de Presupuesto
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="number" id="total-pagado">$0</div>
                                <div class="label">Total Pagado</div>
                            </div>
                            <div class="col-6">
                                <div class="number" id="presupuesto-restante">$500,000</div>
                                <div class="label">Presupuesto Restante</div>
                            </div>
                        </div>
                        <div class="budget-info">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Progreso:</span>
                                <strong id="porcentaje-usado">0%</strong>
                            </div>
                            <div class="progress budget-progress">
                                <div id="budget-progress" class="progress-bar bg-success" style="width: 0%"></div>
                            </div>
                            <small class="text-light">Presupuesto total: $500,000 COP</small>
                        </div>
                        <div id="budget-alert" class="alert budget-alert" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>¬°Presupuesto excedido!</strong><br>
                            Has superado el presupuesto por: <span id="exceso-presupuesto">$0</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Estad√≠sticas r√°pidas por producto y estado -->
            <div class="col-lg-6">
                <div class="row">
                    <div class="col-4">
                        <div class="card stats-card">
                            <div class="number" id="total-descongel">0</div>
                            <div class="label">Descongel x100</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card stats-card">
                            <div class="number" id="total-multidol400">0</div>
                            <div class="label">Multidol 400mg</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card stats-card">
                            <div class="number" id="total-multidol800">0</div>
                            <div class="label">Multidol 800mg</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="card stats-card status-stats">
                            <div class="number" id="total-pendientes">0</div>
                            <div class="label">‚è≥ Pendientes</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card stats-card status-stats">
                            <div class="number" id="total-procesados">0</div>
                            <div class="label">‚úÖ Procesados</div>
                        </div>
                    </div>
                </div>
                <div class="card stats-card">
                    <div class="number" id="total-pagos">0</div>
                    <div class="label">Total de Pagos Registrados</div>
                </div>
            </div>
        </div>

        <!-- PRINCIPAL: FORMULARIO + TABLA  -->
        <div class="row">
            <div class="col-lg-4">
                <!-- Formulario de Registro de Pago -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-plus-circle me-2"></i>Registrar Nuevo Pago
                    </div>
                    <div class="card-body">
                        <form id="payment-form">
                            <div class="mb-3">
                                <label for="pharmacy" class="form-label">Nombre de Farmacia</label>
                                <input type="text" class="form-control" id="pharmacy" required>
                            </div>
                            <div class="mb-3">
                                <label for="product" class="form-label">Producto</label>
                                <select class="form-select" id="product" required>
                                    <option value="">Seleccionar producto</option>
                                    <option value="descongel">Descongel x100 c√°psulas</option>
                                    <option value="multidol400">Multidol 400mg</option>
                                    <option value="multidol800">Multidol 800mg</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Cantidad <span class="text-muted">(unidades)</span></label>
                                <input type="number" class="form-control" id="quantity" min="1" step="1" required placeholder="Ej: 5">
                            </div>
                            <div class="mb-3">
                                <label for="unitPrice" class="form-label">Valor por Unidad (COP)</label>
                                <input type="number" class="form-control" id="unitPrice" min="0" step="100" required placeholder="Ej: 5000">
                            </div>
                            <div id="total-container" class="total-display" style="display: none;">
                                <div class="label">üí∞ Total a Pagar:</div>
                                <div class="amount" id="total-display">$0</div>
                                <input type="hidden" id="total-value" value="">
                            </div>
                            <div class="mb-3">
                                <label for="status" class="form-label">Estado del Pago</label>
                                <select class="form-select" id="status" required>
                                    <option value="pendiente">‚è≥ Pendiente</option>
                                    <option value="procesado">‚úÖ Procesado</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="date" class="form-label">Fecha de Pago</label>
                                <input type="date" class="form-control" id="date" required>
                            </div>
                            <div class="mb-3">
                                <label for="notes" class="form-label">Descripci√≥n/Notas</label>
                                <textarea class="form-control" id="notes" rows="2" placeholder="Ej: Pago por medicamentos del mes de agosto"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-2"></i>Registrar Pago
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tabla de Pagos y Filtros -->
            <div class="col-lg-8">
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="filter-product" class="form-label">Filtrar por Producto</label>
                            <select class="form-select" id="filter-product">
                                <option value="">Todos los productos</option>
                                <option value="descongel">Descongel x100 c√°psulas</option>
                                <option value="multidol400">Multidol 400mg</option>
                                <option value="multidol800">Multidol 800mg</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter-pharmacy" class="form-label">Filtrar por Farmacia</label>
                            <select class="form-select" id="filter-pharmacy">
                                <option value="">Todas las farmacias</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter-status" class="form-label">Filtrar por Estado</label>
                            <select class="form-select" id="filter-status">
                                <option value="">Todos los estados</option>
                                <option value="pendiente">‚è≥ Pendiente</option>
                                <option value="procesado">‚úÖ Procesado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter-date" class="form-label">Filtrar por Fecha</label>
                            <input type="month" class="form-control" id="filter-date">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list me-2"></i>Historial de Pagos</span>
                        <button class="btn btn-sm btn-outline-light" id="refresh-btn">
                            <i class="fas fa-sync-alt"></i> <span class="d-none d-md-inline">Actualizar</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Farmacia</th>
                                        <th>Producto</th>
                                        <th>Cant.</th>
                                        <th>Valor Unit.</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Descripci√≥n</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n flotante de ‚ÄúRecargar Saldo‚Äù -->
    <button class="btn btn-success btn-floating" id="recharge-btn"
        style="position:fixed;bottom:25px;right:25px;z-index:99;display:none">
        <i class="fas fa-coins me-1"></i> Recargar Saldo
    </button>

    <div class="footer text-center">
        <div class="container">
            <p class="mb-0">CRM Control de Pagos &copy; 2025 - Sistema de gesti√≥n de medicamentos</p>
        </div>
    </div>
    <!-- Firebase & JS principal -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDK2Aoz1kxq1dDXKkemRIYCFAFtxgw4dZs",
            authDomain: "crm-medicamentos.firebaseapp.com",
            projectId: "crm-medicamentos",
            storageBucket: "crm-medicamentos.appspot.com",
            messagingSenderId: "638953546971",
            appId: "1:638953546971:web:4f811cdd7dd72dc7cfd8fe",
            measurementId: "G-RPZNJSCX12"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const paymentsCol = collection(db, "pagos");

        // CONSTANTES Y VARIABLES
        const BUDGET_TOTAL = 500000;
        let currentBudget = BUDGET_TOTAL;
        let pagosData = []; // Todos los pagos cargados de Firestore (se filtra localmente)

        // UTILIDADES
        function formatCurrency(value) {
            return "$" + value.toLocaleString("es-CO");
        }
        function showToast(mensaje, tipo = "info") {
            let color = (tipo === "success") ? "#30bf68" : (tipo === "danger") ? "#c22b2b" : "#40a0f3";
            const toast = document.createElement("div");
            toast.innerHTML = mensaje;
            toast.style.position = "fixed";
            toast.style.background = color;
            toast.style.color = "#fff";
            toast.style.bottom = "85px";
            toast.style.right = "25px";
            toast.style.padding = "13px 25px";
            toast.style.borderRadius = "25px";
            toast.style.zIndex = "1050";
            toast.style.boxShadow = "0 8px 16px #1abc9c47";
            toast.style.fontSize = "1rem";
            toast.style.fontWeight = "500";
            document.body.appendChild(toast);
            setTimeout(()=>{toast.remove();}, 2200);
        }

        // ACTUALIZA UNICAMENTE EL PRESUPUESTO Y ALERTAS
        function updateBudgetUI(totalPagado) {
            currentBudget = Math.max(BUDGET_TOTAL - totalPagado, 0);
            document.getElementById("presupuesto-restante").textContent = formatCurrency(currentBudget);
            document.getElementById("total-pagado").textContent = formatCurrency(totalPagado);
            let porcent = (totalPagado * 100) / BUDGET_TOTAL;
            if (porcent > 100) porcent = 100;
            document.getElementById("porcentaje-usado").textContent = `${porcent.toFixed(1)}%`;
            document.getElementById("budget-progress").style.width = `${porcent}%`;
            // Bot√≥n recarga solo si ya gast√≥ parte del saldo
            document.getElementById('recharge-btn').style.display = (currentBudget < BUDGET_TOTAL) ? 'block' : 'none';
            // Alerta sobrepaso
            const alert = document.getElementById("budget-alert");
            if ((BUDGET_TOTAL - totalPagado) < 0) {
                alert.style.display = "block";
                document.getElementById("exceso-presupuesto").innerText = formatCurrency(Math.abs(BUDGET_TOTAL - totalPagado));
            } else {
                alert.style.display = "none";
            }
        }

        // ACTUALIZA STATS PRODUCTOS Y ESTADOS
        function updateStatsCards() {
            const dc = pagosData.filter(p=>p.producto === 'descongel').length;
            const md4 = pagosData.filter(p=>p.producto === 'multidol400').length;
            const md8 = pagosData.filter(p=>p.producto === 'multidol800').length;
            const pend = pagosData.filter(p=>p.estado === 'pendiente').length;
            const proc = pagosData.filter(p=>p.estado === 'procesado').length;
            document.getElementById("total-descongel").textContent = dc;
            document.getElementById("total-multidol400").textContent = md4;
            document.getElementById("total-multidol800").textContent = md8;
            document.getElementById("total-pendientes").textContent = pend;
            document.getElementById("total-procesados").textContent = proc;
            document.getElementById("total-pagos").textContent = pagosData.length;
        }

        // CARGA Y PINTA LA TABLA DE PAGOS, STATS Y PRESUPUESTO
        async function loadPayments(forceRecharge = false) {
            const resp = await getDocs(query(paymentsCol, orderBy('fecha', 'desc')));
            pagosData = [];
            let totalPagado = 0;
            let farmaciasSet = new Set();
            resp.forEach(docSnap => {
                let d = docSnap.data();
                d.id = docSnap.id;
                pagosData.push(d);
                farmaciasSet.add(d.farmacia);
            });

            // Si filtra por alg√∫n criterio, filtra aqu√≠ (opcional, usa filtros de inputs)
            // Calcular totalPagado s√≥lo de pagos procesados
            pagosData.forEach(p => {
                if (p.estado === "procesado") totalPagado += Number(p.total);
            });

            // Si fuerza recarga (tras recargar saldo), NO descuenta pagos anteriores
            if(forceRecharge) totalPagado = 0;

            updateBudgetUI(totalPagado);
            updateStatsCards();

            // Opciones a filtros de farmacia
            let fOptions = '<option value="">Todas las farmacias</option>';
            [...farmaciasSet].sort().forEach(f=>{fOptions += `<option value="${f}">${f}</option>`;});
            document.getElementById("filter-pharmacy").innerHTML = fOptions;

            // Pinta la tabla HTML
            paintTable(pagosData);
        }

        // PINTAR TABLA (usa todos los pagosData en memoria)
        function paintTable(array) {
            let tbody = "";
            array.forEach(p => {
                tbody += `
                <tr>
                    <td>${p.fecha||""}</td>
                    <td>${p.farmacia}</td>
                    <td>${getProductName(p.producto)}</td>
                    <td>${p.cantidad}</td>
                    <td>${formatCurrency(Number(p.valorUnidad)||0)}</td>
                    <td>${formatCurrency(Number(p.total)||0)}</td>
                    <td>${p.estado==="pendiente"?"‚è≥":"‚úÖ"}</td>
                    <td>${p.nota||""}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="eliminarPago('${p.id}')">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            document.getElementById("payments-table").innerHTML = tbody;
        }

        // OBTIENE NOMBRE DEL PRODUCTO
        function getProductName(val) {
            if(val==="descongel") return "Descongel x100";
            if(val==="multidol400") return "Multidol 400mg";
            if(val==="multidol800") return "Multidol 800mg";
            return "";
        }

        // ELIMINAR PAGO
        window.eliminarPago = async function(id) {
            await deleteDoc(doc(db, "pagos", id));
            showToast("Pago eliminado", "danger");
            loadPayments();
        }

        // EVENTOS FORMULARIO ---------------------------------
        document.getElementById("payment-form").addEventListener("submit", async function(evt){
            evt.preventDefault();
            const farmacia = document.getElementById("pharmacy").value.trim();
            const producto = document.getElementById("product").value;
            const cantidad = parseInt(document.getElementById("quantity").value);
            const valorUnidad = parseInt(document.getElementById("unitPrice").value);
            const estado = document.getElementById("status").value;
            const fecha = document.getElementById("date").value;
            const nota = document.getElementById("notes").value;
            const total = cantidad * valorUnidad;

            // Validaci√≥n de presupuesto (no permitir exceder)
            let totalPagado = 0;
            pagosData.forEach(p => { if (p.estado === "procesado") totalPagado += Number(p.total); });
            if ((totalPagado + ((estado==="procesado")?total:0)) > BUDGET_TOTAL) {
                showToast("No puedes registrar este pago: se excede el presupuesto ‚úÖ. Recarga saldo antes.", "danger");
                return;
            }

            await addDoc(paymentsCol, {
                farmacia, producto, cantidad, valorUnidad, estado, fecha, nota, total
            });
            showToast("Pago registrado", "success");
            this.reset();
            document.getElementById("total-container").style.display = "none";
            loadPayments();
        });

        // Calcula y muestra total en formulario
        document.getElementById("quantity").addEventListener("input", updateTotalForm);
        document.getElementById("unitPrice").addEventListener("input", updateTotalForm);
        function updateTotalForm() {
            let c = parseInt(document.getElementById("quantity").value) || 0;
            let v = parseInt(document.getElementById("unitPrice").value) || 0;
            let t = c*v;
            if (c && v) {
                document.getElementById("total-container").style.display = "block";
                document.getElementById("total-display").innerText = formatCurrency(t);
                document.getElementById("total-value").value = t;
            } else {
                document.getElementById("total-container").style.display = "none";
            }
        }

        // Evento de filtros (puedes expandir l√ìgica si quieres que filtre tambi√©n servidor)
        document.getElementById("filter-product").addEventListener("change", applyFilters);
        document.getElementById("filter-pharmacy").addEventListener("change", applyFilters);
        document.getElementById("filter-status").addEventListener("change", applyFilters);
        document.getElementById("filter-date").addEventListener("change", applyFilters);

        function applyFilters() {
            let arr = pagosData;
            const fprod = document.getElementById("filter-product").value;
            const fpharm = document.getElementById("filter-pharmacy").value;
            const fest = document.getElementById("filter-status").value;
            const fdate = document.getElementById("filter-date").value;
            if (fprod) arr = arr.filter(p=>p.producto === fprod);
            if (fpharm) arr = arr.filter(p=>p.farmacia === fpharm);
            if (fest) arr = arr.filter(p=>p.estado === fest);
            if (fdate) arr = arr.filter(p=>(p.fecha||"").slice(0,7) === fdate); // Match a√±o-mes
            paintTable(arr);
        }

        // Evento bot√≥n refresh
        document.getElementById("refresh-btn").addEventListener("click", ()=>loadPayments());

        // --- BOT√ìN FLOTANTE PARA RECARGAR SALDO ---
        document.getElementById('recharge-btn').addEventListener('click', function () {
            showToast('¬°Saldo recargado a $500,000 COP!','success');
            loadPayments(true); // recarga saldo (nuevo ciclo)
        });

        // Inicializaci√≥n
        loadPayments();

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
