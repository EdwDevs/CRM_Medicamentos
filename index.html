<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM Control de Pagos - Medicamentos (robusto + edici√≥n + diagn√≥stico)</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --primary:#2c3e50; --secondary:#3498db; --success:#27ae60;
      --warning:#f39c12; --danger:#e74c3c; --light:#ecf0f1; --dark:#34495e;
    }
    html,body{background:#f8f9fa;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif;}
    .app-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:1rem 0 1.25rem;box-shadow:0 2px 8px rgba(0,0,0,.12);position:sticky;top:0;z-index:20}
    .app-header .lead{opacity:.95}
    .card{border:0;border-radius:14px;box-shadow:0 6px 16px rgba(15,23,42,.06)}
    .card-header{border:0;border-radius:14px 14px 0 0;background:var(--primary);color:#fff;font-weight:600}
    .stats-card{padding:1rem;text-align:center}
    .stats-card .number{font-size:1.8rem;font-weight:800;color:var(--primary)}
    .budget-card{background:linear-gradient(135deg,#2c3e50,#3f5370);color:#fff}
    .budget-card .number{color:#fff}
    .budget-info{background:rgba(255,255,255,.12);border-radius:10px;padding:.8rem;margin-top:.75rem}
    .badge-descongel{background:#3498db}
    .badge-multidol400{background:#2ecc71}
    .badge-multidol800{background:#9b59b6}
    .status-toggle-btn{border:none !important;border-radius:20px;padding:.35rem .7rem;font-size:.85rem}
    .status-stats{background:linear-gradient(135deg,#8e44ad,#9b59b6);color:#fff}
    .toast-notification{position:fixed;top:16px;right:16px;background:#27ae60;color:#fff;padding:.9rem 1.1rem;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.18);z-index:2000;transition:opacity .3s}
    .toast-error{background:#e74c3c}
    .loading-skeleton{height:12px;background:linear-gradient(90deg,#eee 25%,#f5f5f5 37%,#eee 63%);background-size:400% 100%;animation:skeleton 1.4s ease infinite;border-radius:6px}
    @keyframes skeleton{0%{background-position:100% 0}100%{background-position:0 0}}
    .table-wrap{width:100%}
    @media (max-width: 768px){
      .table thead{display:none}
      .table tbody tr{display:block;background:#fff;border-radius:12px;margin-bottom:.75rem;box-shadow:0 4px 14px rgba(0,0,0,.06)}
      .table tbody td{display:flex;justify-content:space-between;gap:12px;padding:.75rem 1rem;border-bottom:1px dashed #eee}
      .table tbody td:last-child{border-bottom:0}
      .table tbody td::before{content:attr(data-label);font-weight:600;color:#6b7280}
      .action-buttons .btn{min-width:40px}
    }
    .modal-content{border:0;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.22)}
    .form-control,.form-select{min-height:46px;font-size:16px}
    .btn{min-height:44px}
    .table-hover>tbody>tr:hover>*{background:rgba(52,152,219,.04)}
  </style>

  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, updateDoc, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyDK2Aoz1kxq1dDXKkemRIYCFAFtxgw4dZs",
      authDomain: "crm-medicamentos.firebaseapp.com",
      projectId: "crm-medicamentos",
      storageBucket: "crm-medicamentos.appspot.com",
      messagingSenderId: "638953546971",
      appId: "1:638953546971:web:4f811cdd7dd72dc7cfd8fe",
      measurementId: "G-RPZNJSCX12"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e){ /* Analytics puede fallar en http/local */ }
    const db = getFirestore(app);

    // Presupuesto
    const BUDGET_TOTAL = 500000;

    // Utilidades
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    const PRODUCTS = {
      descongel:{name:"Descongel x100 c√°psulas", cls:"descongel", icon:"‚ùÑÔ∏è"},
      multidol400:{name:"Multidol 400mg", cls:"multidol400", icon:"üíä"},
      multidol800:{name:"Multidol 800mg", cls:"multidol800", icon:"üíä"}
    };
    function getProductName(k){return (PRODUCTS[k]?.name)||k}
    function getProductClass(k){return (PRODUCTS[k]?.cls)||""}
    function getProductIcon(k){return (PRODUCTS[k]?.icon)||"üì¶"}
    function getPaymentStatus(s){
      const map={
        pendiente:{label:"Pendiente", class:"bg-warning text-dark", icon:"‚è≥"},
        procesado:{label:"Procesado", class:"bg-success text-white", icon:"‚úÖ"}
      };return map[s]||map.pendiente
    }
    function toDate(d){
      if(d instanceof Date) return d;
      if(d?.toDate) return d.toDate(); // Firestore Timestamp
      if(typeof d==="string") return new Date(d+"T00:00:00");
      return new Date(d);
    }
    function formatDate(d){
      const dt = toDate(d);
      return dt.toLocaleDateString("es-CO",{year:"numeric",month:"short",day:"numeric"});
    }
    function toDateInputValue(d){
      const dt = toDate(d);
      const yyyy = dt.getFullYear();
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const dd = String(dt.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function formatCurrency(v){
      const n = Number(v||0);
      return new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
    }
    function showToast(msg,type="success"){
      const id="toast-"+Date.now();
      const icon = type==="success" ? "check-circle" : "exclamation-circle";
      const el = document.createElement("div");
      el.id=id;
      el.className=`toast-notification ${type==="error"?"toast-error":""}`;
      el.innerHTML=`<i class="fas fa-${icon} me-2"></i>${msg}`;
      document.body.appendChild(el);
      setTimeout(()=>{el.style.opacity="0"; setTimeout(()=>el.remove(),300)},3000);
    }
    function spinnerRow(){
      return `
        <tr>
          <td colspan="9">
            <div class="p-3">
              <div class="loading-skeleton mb-2" style="height:16px;width:35%"></div>
              <div class="loading-skeleton mb-2" style="height:12px;width:80%"></div>
              <div class="loading-skeleton" style="height:12px;width:55%"></div>
            </div>
          </td>
        </tr>`;
    }

    // C√°lculo de total (alta)
    function calculateTotal(){
      const q = Number($('#quantity').value||0);
      const up = Number($('#unitPrice').value||0);
      const total = q*up;
      $('#total-display').textContent = formatCurrency(total);
      $('#total-value').value = String(total);
      $('#total-container').style.display = (q>0 && up>0) ? 'block' : 'none';
    }
    // C√°lculo de total (edici√≥n)
    function calculateEditTotal(){
      const q = Number($('#edit-quantity').value||0);
      const up = Number($('#edit-unitPrice').value||0);
      const total = q*up;
      $('#edit-total-display').textContent = formatCurrency(total);
      $('#edit-total-value').value = String(total);
      $('#edit-total-container').style.display = (q>0 && up>0) ? 'block' : 'none';
    }

    // ========= Backfill y normalizaci√≥n =========
    async function backfillMissingStatus(docs){
      const toFix = docs.filter(d => !("status" in d.data()));
      if(toFix.length===0) return;
      const batchSize = Math.min(toFix.length, 10);
      for(let i=0;i<batchSize;i++){
        try{
          await updateDoc(doc(db,"payments",toFix[i].id), { status:"pendiente" });
        }catch(e){ console.warn("Backfill status error", e); }
      }
    }
    function normalizeClientData(payments){
      return payments.map(p=>{
        const date = toDate(p.date);
        const unitPrice = Number(p.unitPrice ?? p.amount ?? 0);
        const totalAmount = Number(p.totalAmount ?? p.amount ?? (Number(p.quantity||1)*unitPrice));
        const status = p.status || "pendiente";
        return {...p, date, unitPrice, totalAmount, status};
      });
    }

    // ======== Helper: traer todo sin filtros (no requiere √≠ndices) ========
    async function fetchAllPaymentsRaw(){
      const snap = await getDocs(collection(db, "payments"));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    function showIndexHelp(url){
      const tbody = $('#payments-table');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td colspan="9" class="text-center text-warning py-3">
          <i class="fa-solid fa-triangle-exclamation me-2"></i>
          Esta combinaci√≥n de filtros requiere un √≠ndice compuesto para mejorar rendimiento.
          <a href="${url}" target="_blank" rel="noopener" class="ms-1">Crear √≠ndice en Firebase</a>.
        </td>`;
      tbody.prepend(row);
    }

    // ========= Carga robusta con TRIPLE fallback + MARCAS A/B/C =========
    async function loadPayments(){
      const tbody = $('#payments-table');
      tbody.innerHTML = spinnerRow()+spinnerRow()+spinnerRow();

      // Filtros de UI
      const pf  = $('#filter-product').value || "";
      const phf = $('#filter-pharmacy').value || "";
      const df  = $('#filter-date').value || ""; // yyyy-mm
      const sf  = $('#filter-status').value || "";

      // Rango por fecha si se selecciona mes
      let start=null, end=null;
      if(df){
        start = new Date(df+"-01T00:00:00");
        end = new Date(start); end.setMonth(end.getMonth()+1);
      }

      const extractIndexLink = (msg) => {
        const m = String(msg||"").match(/https:\/\/console\.firebase\.google\.com\/[^\s]+/);
        return m ? m[0] : null;
      };

      // -------- Intento A: filtros completos + orderBy(date) --------
      try{
        const constraints = [];
        if(start && end){ constraints.push(where("date",">=",start), where("date","<",end)); }
        if(pf)  constraints.push(where("product","==",pf));
        if(phf) constraints.push(where("pharmacy","==",phf));
        if(sf)  constraints.push(where("status","==",sf));
        constraints.push(orderBy("date","desc"));

        const qy = query(collection(db,"payments"), ...constraints);
        const snap = await getDocs(qy);
        await backfillMissingStatus(snap.docs);

        const paymentsA = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        // Marca A (diagn√≥stico)
        if (typeof window.__HP_MARK_A__ === 'function') window.__HP_MARK_A__(paymentsA.length);

        renderPayments(paymentsA);
        return; // OK
      }catch(errA){
        console.warn("Intento A fall√≥:", errA?.message);
        const link = extractIndexLink(errA?.message);
        if(link) showIndexHelp(link);
      }

      // -------- Intento B: s√≥lo rango de fecha + orderBy(date) --------
      try{
        const base = [];
        if(start && end){ base.push(where("date",">=",start), where("date","<",end)); }
        base.push(orderBy("date","desc"));

        const qBase = query(collection(db,"payments"), ...base);
        const snapAll = await getDocs(qBase);
        await backfillMissingStatus(snapAll.docs);

        let paymentsB = snapAll.docs.map(d => ({ id:d.id, ...d.data() }));
        paymentsB = normalizeClientData(paymentsB);

        // Filtros restantes en cliente
        paymentsB = paymentsB.filter(p=>{
          const okP  = pf  ? p.product  === pf  : true;
          const okPh = phf ? p.pharmacy === phf : true;
          const okS  = sf  ? p.status   === sf  : true;
          return okP && okPh && okS;
        });

        // Marca B (diagn√≥stico)
        if (typeof window.__HP_MARK_B__ === 'function') window.__HP_MARK_B__(paymentsB.length);

        renderPayments(paymentsB);
        return; // OK
      }catch(errB){
        console.warn("Intento B fall√≥:", errB?.message);
        const link = extractIndexLink(errB?.message);
        if(link) showIndexHelp(link);
      }

      // -------- Intento C: traer todo y resolver en cliente --------
      try{
        let paymentsC = await fetchAllPaymentsRaw(); // sin where/orderBy => sin √≠ndices
        paymentsC = normalizeClientData(paymentsC);

        // Filtro por mes en cliente
        if(start && end){
          paymentsC = paymentsC.filter(p => {
            const dt = toDate(p.date);
            return dt >= start && dt < end;
          });
        }
        // Filtros restantes en cliente
        paymentsC = paymentsC.filter(p=>{
          const okP  = pf  ? p.product  === pf  : true;
          const okPh = phf ? p.pharmacy === phf : true;
          const okS  = sf  ? p.status   === sf  : true;
          return okP && okPh && okS;
        });
        // Ordenar por fecha en cliente, mandando sin fecha al final
        paymentsC.sort((a,b)=>{
          const da = toDate(a.date)?.getTime() ?? -Infinity;
          const db = toDate(b.date)?.getTime() ?? -Infinity;
          return db - da;
        });

        // Marca C (diagn√≥stico)
        if (typeof window.__HP_MARK_C__ === 'function') window.__HP_MARK_C__(paymentsC.length);

        renderPayments(paymentsC);
      }catch(errC){
        console.error("Intento C fall√≥:", errC);
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger py-4">
          Error al cargar datos. Revisa la consola para m√°s detalles.
        </td></tr>`;
      }
    }

    function renderPayments(raw){
      const tbody = $('#payments-table');
      tbody.innerHTML = "";

      const payments = normalizeClientData(raw);

      payments.forEach(p=>{
        const st = getPaymentStatus(p.status);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Fecha">${formatDate(p.date)}</td>
          <td data-label="Farmacia"><strong>${p.pharmacy||"-"}</strong></td>
          <td data-label="Producto">
            <span class="me-1">${getProductIcon(p.product)}</span>
            <span class="badge badge-${getProductClass(p.product)}">${getProductName(p.product)}</span>
          </td>
          <td data-label="Cant."><strong>${p.quantity||1}</strong></td>
          <td data-label="Valor Unit.">${formatCurrency(p.unitPrice)}</td>
          <td data-label="Total"><strong>${formatCurrency(p.totalAmount)}</strong></td>
          <td data-label="Estado" class="text-center">
            <button class="btn btn-sm status-toggle-btn ${st.class}" data-action="toggle" data-id="${p.id}" data-status="${p.status}" title="Cambiar estado">
              ${st.icon} ${st.label}
            </button>
          </td>
          <td data-label="Descripci√≥n">
            <small class="text-muted">${p.notes ? (p.notes.length>60 ? p.notes.slice(0,60)+"‚Ä¶" : p.notes) : "Sin descripci√≥n"}</small>
          </td>
          <td data-label="Acciones" class="action-buttons">
            <button class="btn btn-sm btn-outline-primary me-1" data-action="edit" data-id="${p.id}" title="Editar">
              <i class="fas fa-pen"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary me-1" data-action="view" data-id="${p.id}" title="Ver detalles">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${p.id}" title="Eliminar">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      if(payments.length===0){
        tbody.innerHTML = `
          <tr><td colspan="9" class="text-center text-muted py-4">
            <i class="fa-regular fa-folder-open me-2"></i>No se encontraron pagos con los filtros aplicados.
          </td></tr>`;
      }

      updateStats(payments);
      updatePharmacyFilter(payments);
    }

    function updateStats(payments){
      $('#total-pagos').textContent = payments.length;

      const c = (k)=>payments.filter(p=>p.product===k).length;
      $('#total-descongel').textContent = c('descongel');
      $('#total-multidol400').textContent = c('multidol400');
      $('#total-multidol800').textContent = c('multidol800');

      const pend = payments.filter(p=>p.status==='pendiente').length;
      const proc = payments.filter(p=>p.status==='procesado').length;
      $('#total-pendientes').textContent = pend;
      $('#total-procesados').textContent = proc;

      const total = payments.reduce((s,p)=> s + Number(p.totalAmount||0), 0);
      const restante = BUDGET_TOTAL - total;
      const pct = (total/BUDGET_TOTAL)*100;

      $('#total-pagado').textContent = formatCurrency(total);
      $('#presupuesto-restante').textContent = formatCurrency(restante);
      $('#porcentaje-usado').textContent = `${isFinite(pct)?pct.toFixed(1):0}%`;

      const bar = $('#budget-progress');
      bar.style.width = `${Math.min(pct,100)}%`;
      bar.className = 'progress-bar';
      if(pct>=90){bar.classList.add('bg-danger')}
      else if(pct>=75){bar.classList.add('bg-warning')}
      else{bar.classList.add('bg-success')}

      const alert = $('#budget-alert');
      if(total>BUDGET_TOTAL){
        alert.style.display='block';
        $('#exceso-presupuesto').textContent = formatCurrency(total-BUDGET_TOTAL);
      }else{
        alert.style.display='none';
      }
    }

    function updatePharmacyFilter(payments){
      const sel = $('#filter-pharmacy');
      const current = sel.value;
      const names = [...new Set(payments.map(p=>p.pharmacy).filter(Boolean))].sort();
      sel.innerHTML = '<option value="">Todas</option>';
      names.forEach(n=>{
        const opt=document.createElement('option');
        opt.value=n; opt.textContent=n; sel.appendChild(opt);
      });
      if(names.includes(current)) sel.value=current;
    }

    // ======= CRUD: Alta, Edici√≥n, Borrado =======
    async function addPayment(pharmacy,product,quantity,unitPrice,totalAmount,date,notes,status){
      try{
        const payload = {
          pharmacy,
          product,
          quantity:Number(quantity),
          unitPrice:Number(unitPrice),
          totalAmount:Number(totalAmount),
          amount:Number(totalAmount), // compat con datos antiguos
          date:new Date(date+"T00:00:00"),
          notes:notes||"",
          status:status||"pendiente"
        };
        await addDoc(collection(db,"payments"),payload);
        await loadPayments();
        const info=getPaymentStatus(payload.status);
        showToast(`‚úÖ Pago registrado como: ${info.label}`,"success");
      }catch(e){
        console.error(e); showToast("‚ùå Error al registrar el pago","error");
      }
    }

    async function updatePayment(id, data){
      try{
        const payload = {
          pharmacy: data.pharmacy,
          product: data.product,
          quantity: Number(data.quantity),
          unitPrice: Number(data.unitPrice),
          totalAmount: Number(data.totalAmount),
          amount: Number(data.totalAmount), // compat
          date: new Date(data.date+"T00:00:00"),
          notes: data.notes || "",
          status: data.status || "pendiente"
        };
        await updateDoc(doc(db, "payments", id), payload);
        await loadPayments();
        const info=getPaymentStatus(payload.status);
        showToast(`‚úèÔ∏è Pago actualizado: ${info.label}`,"success");
      }catch(e){
        console.error(e); showToast("‚ùå Error al actualizar el pago","error");
      }
    }

    async function deletePayment(id){
      if(!confirm("¬øEst√° seguro de eliminar este pago?")) return;
      try{
        await deleteDoc(doc(db,"payments",id));
        await loadPayments();
        showToast("üóëÔ∏è Pago eliminado correctamente","success");
      }catch(e){
        console.error(e); showToast("‚ùå Error al eliminar el pago","error");
      }
    }

    async function viewPayment(id){
      try{
        const qy = query(collection(db,"payments"), where("__name__","==",id), limit(1));
        const snap = await getDocs(qy);
        if(!snap.empty){
          const d = snap.docs[0];
          openDetailsModal({id:d.id, ...d.data()});
        }else{
          showToast("No se encontraron detalles del pago.","error");
        }
      }catch(e){
        console.error(e);
        showToast("‚ùå Error al obtener detalles del pago","error");
      }
    }

    // Toggle estado
    async function togglePaymentStatus(id,currentStatus){
      const next = currentStatus==="pendiente" ? "procesado" : "pendiente";
      try{
        await updateDoc(doc(db,"payments",id),{status:next});
        const info=getPaymentStatus(next);
        showToast(`${info.icon} Estado cambiado a: ${info.label}`,"success");
        await loadPayments();
      }catch(e){
        console.error(e); showToast("‚ùå Error al cambiar el estado","error");
      }
    }

    // ======= Modal: Detalles =======
    function openDetailsModal(payment){
      const modalTitle = $('#detailsTitle');
      const modalBody = $('#detailsBody');
      const dt = toDate(payment.date);
      const status = getPaymentStatus(payment.status||'pendiente');

      modalTitle.textContent = `Pago ‚Ä¢ ${getProductName(payment.product)}`;
      modalBody.innerHTML = `
        <div class="d-flex align-items-center mb-2">
          <span class="me-2">${getProductIcon(payment.product)}</span>
          <span class="badge badge-${getProductClass(payment.product)}">${getProductName(payment.product)}</span>
        </div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>Farmacia:</strong> ${payment.pharmacy||"-"}</li>
          <li class="list-group-item"><strong>Fecha:</strong> ${formatDate(dt)}</li>
          <li class="list-group-item"><strong>Cantidad:</strong> ${payment.quantity||1}</li>
          <li class="list-group-item"><strong>Valor Unitario:</strong> ${formatCurrency(payment.unitPrice ?? payment.amount ?? 0)}</li>
          <li class="list-group-item"><strong>Total:</strong> ${formatCurrency(payment.totalAmount ?? payment.amount ?? 0)}</li>
          <li class="list-group-item">
            <strong>Estado:</strong>
            <span class="ms-2 badge ${status.class}">${status.icon} ${status.label}</span>
          </li>
          <li class="list-group-item"><strong>Notas:</strong> ${payment.notes||"‚Äî"}</li>
          <li class="list-group-item"><small class="text-muted">ID: ${payment.id}</small></li>
        </ul>`;
      const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
      modal.show();
    }

    // ======= Modal: Edici√≥n =======
    async function openEditById(id){
      try{
        const qy = query(collection(db,"payments"), where("__name__","==",id), limit(1));
        const snap = await getDocs(qy);
        if(snap.empty){ showToast("No se pudo cargar el registro a editar","error"); return; }
        const d = snap.docs[0];
        const data = { id: d.id, ...d.data() };
        fillEditForm(data);
        const m = new bootstrap.Modal(document.getElementById('editModal'));
        m.show();
      }catch(e){
        console.error(e);
        showToast("‚ùå Error al cargar datos para edici√≥n","error");
      }
    }

    function fillEditForm(p){
      $('#edit-id').value = p.id;
      $('#edit-pharmacy').value = p.pharmacy || "";
      $('#edit-product').value = p.product || "";
      $('#edit-quantity').value = Number(p.quantity || 1);
      const unitPrice = Number(p.unitPrice ?? (Number(p.totalAmount ?? p.amount ?? 0) / Number(p.quantity || 1)) || 0);
      $('#edit-unitPrice').value = unitPrice;
      const totalAmount = Number(p.totalAmount ?? p.amount ?? (unitPrice * Number(p.quantity||1)));
      $('#edit-total-display').textContent = formatCurrency(totalAmount);
      $('#edit-total-value').value = String(totalAmount);
      $('#edit-status').value = p.status || "pendiente";
      $('#edit-date').value = toDateInputValue(p.date);
      $('#edit-notes').value = p.notes || "";
      $('#edit-total-container').style.display = (totalAmount>0) ? 'block' : 'none';
    }

    // ======= Eventos =======
    document.addEventListener("DOMContentLoaded", ()=>{
      // Fecha por defecto hoy (alta)
      const today = new Date(); const yyyy=today.getFullYear(); const mm=String(today.getMonth()+1).padStart(2,'0'); const dd=String(today.getDate()).padStart(2,'0');
      $('#date').value = `${yyyy}-${mm}-${dd}`;

      // Listeners formulario alta
      $('#quantity').addEventListener('input', calculateTotal);
      $('#unitPrice').addEventListener('input', calculateTotal);

      // Submit alta
      $('#payment-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const btn = e.submitter || e.target.querySelector('button[type="submit"]');
        btn?.setAttribute('disabled','disabled');

        const pharmacy=$('#pharmacy').value.trim();
        const product=$('#product').value;
        const quantity=$('#quantity').value;
        const unitPrice=$('#unitPrice').value;
        const totalAmount=$('#total-value').value;
        const date=$('#date').value;
        const notes=$('#notes').value;
        const status=$('#status').value;

        if(pharmacy && product && quantity && unitPrice && totalAmount && date){
          await addPayment(pharmacy,product,quantity,unitPrice,totalAmount,date,notes,status);
          e.target.reset();
          $('#date').value = `${yyyy}-${mm}-${dd}`;
          $('#status').value = 'pendiente';
          $('#total-container').style.display='none';
          $('#total-value').value='';

          const formModalEl = document.getElementById('formModal');
          const formModal = bootstrap.Modal.getOrCreateInstance(formModalEl);
          formModal.hide();
        }else{
          showToast('‚ö†Ô∏è Por favor completa todos los campos requeridos','error');
        }
        btn?.removeAttribute('disabled');
      });

      // Filtros y acciones
      $$('.refresh-btn').forEach(btn=>btn.addEventListener('click', loadPayments));
      $('#filter-product').addEventListener('change', loadPayments);
      $('#filter-pharmacy').addEventListener('change', loadPayments);
      $('#filter-date').addEventListener('change', loadPayments);
      $('#filter-status').addEventListener('change', loadPayments);

      // Tabla: acciones delegadas
      $('#payments-table').addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if(action==="delete") deletePayment(id);
        if(action==="view") viewPayment(id);
        if(action==="toggle") togglePaymentStatus(id, btn.dataset.status);
        if(action==="edit") openEditById(id);
      });

      // Botones para abrir modal de alta (m√≥vil y desktop) - sin IDs duplicados
      $$('.js-open-form').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const m = new bootstrap.Modal(document.getElementById('formModal'));
          m.show();
        });
      });

      // Edit: listeners de c√°lculo
      $('#edit-quantity').addEventListener('input', calculateEditTotal);
      $('#edit-unitPrice').addEventListener('input', calculateEditTotal);

      // Submit edici√≥n
      $('#edit-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const btn = e.submitter || e.target.querySelector('button[type="submit"]');
        btn?.setAttribute('disabled','disabled');

        const id = $('#edit-id').value;
        const pharmacy=$('#edit-pharmacy').value.trim();
        const product=$('#edit-product').value;
        const quantity=$('#edit-quantity').value;
        const unitPrice=$('#edit-unitPrice').value;
        const totalAmount=$('#edit-total-value').value || (Number(quantity)*Number(unitPrice));
        const date=$('#edit-date').value;
        const notes=$('#edit-notes').value;
        const status=$('#edit-status').value;

        if(id && pharmacy && product && quantity && unitPrice && totalAmount && date){
          await updatePayment(id, {pharmacy,product,quantity,unitPrice,totalAmount,date,notes,status});
          const editModalEl = document.getElementById('editModal');
          const editModal = bootstrap.Modal.getOrCreateInstance(editModalEl);
          editModal.hide();
        }else{
          showToast('‚ö†Ô∏è Por favor completa todos los campos requeridos','error');
        }
        btn?.removeAttribute('disabled');
      });

      // Carga inicial
      loadPayments();
    });

    // ---- Exponer funciones para el panel de salud ----
    window.loadPayments  = loadPayments;
    window.renderPayments = renderPayments;
  </script>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="container">
      <h1 class="h4 mb-1"><i class="fas fa-pills me-2"></i>CRM Control de Pagos</h1>
      <p class="lead mb-0">Filtros robustos, normalizaci√≥n de datos y edici√≥n</p>
    </div>
  </header>

  <main class="container my-3">
    <!-- Presupuesto + KPIs -->
    <div class="row g-3 mb-2">
      <div class="col-lg-6">
        <div class="card budget-card">
          <div class="card-header"><i class="fas fa-wallet me-2"></i>Control de Presupuesto</div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-6">
                <div class="number" id="total-pagado">$0</div>
                <div>Total Pagado</div>
              </div>
              <div class="col-6">
                <div class="number" id="presupuesto-restante">$500,000</div>
                <div>Presupuesto Restante</div>
              </div>
            </div>
            <div class="budget-info">
              <div class="d-flex justify-content-between mb-2">
                <span>Progreso</span><strong id="porcentaje-usado">0%</strong>
              </div>
              <div class="progress" role="progressbar" aria-label="Progreso de presupuesto">
                <div id="budget-progress" class="progress-bar bg-success" style="width:0%"></div>
              </div>
              <small class="text-light">Presupuesto total: $500,000 COP</small>
            </div>
            <div id="budget-alert" class="alert mt-3" style="display:none;background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;border:0;border-radius:10px">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>¬°Presupuesto excedido!</strong> Superado por: <span id="exceso-presupuesto">$0</span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="row g-3">
          <div class="col-4">
            <div class="card stats-card">
              <div class="number" id="total-descongel">0</div>
              <div>Descongel x100</div>
            </div>
          </div>
          <div class="col-4">
            <div class="card stats-card">
              <div class="number" id="total-multidol400">0</div>
              <div>Multidol 400mg</div>
            </div>
          </div>
          <div class="col-4">
            <div class="card stats-card">
              <div class="number" id="total-multidol800">0</div>
              <div>Multidol 800mg</div>
            </div>
          </div>
          <div class="col-6">
            <div class="card stats-card status-stats">
              <div class="number" id="total-pendientes">0</div>
              <div>‚è≥ Pendientes</div>
            </div>
          </div>
          <div class="col-6">
            <div class="card stats-card status-stats">
              <div class="number" id="total-procesados">0</div>
              <div>‚úÖ Procesados</div>
            </div>
          </div>
          <div class="col-12">
            <div class="card stats-card">
              <div class="number" id="total-pagos">0</div>
              <div>Total de Pagos Registrados</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros + Historial -->
    <div class="row g-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div><i class="fas fa-filter me-2"></i>Filtros</div>
            <button class="btn btn-sm btn-outline-light refresh-btn"><i class="fas fa-rotate"></i> <span class="d-none d-md-inline">Actualizar</span></button>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-product">Producto</label>
                <select id="filter-product" class="form-select">
                  <option value="">Todos</option>
                  <option value="descongel">Descongel x100 c√°psulas</option>
                  <option value="multidol400">Multidol 400mg</option>
                  <option value="multidol800">Multidol 800mg</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-pharmacy">Farmacia</label>
                <select id="filter-pharmacy" class="form-select">
                  <option value="">Todas</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-status">Estado</label>
                <select id="filter-status" class="form-select">
                  <option value="">Todos</option>
                  <option value="pendiente">‚è≥ Pendiente</option>
                  <option value="procesado">‚úÖ Procesado</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label" for="filter-date">Mes</label>
                <input id="filter-date" type="month" class="form-control"/>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Historial -->
      <div class="col-12">
        <div class="card">
          <div class="card-header"><i class="fas fa-list me-2"></i>Historial de Pagos</div>
          <div class="card-body">
            <div class="table-responsive table-wrap">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Fecha</th><th>Farmacia</th><th>Producto</th><th>Cant.</th>
                    <th>Valor Unit.</th><th>Total</th><th>Estado</th><th>Descripci√≥n</th><th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="payments-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n R√°pida (m√≥vil) -->
    <div class="d-md-none d-flex gap-2 mt-2">
      <button class="btn btn-primary flex-fill js-open-form"><i class="fa fa-plus me-2"></i>Registrar pago</button>
      <button class="btn btn-outline-secondary flex-fill refresh-btn"><i class="fa fa-rotate me-2"></i>Actualizar</button>
    </div>
  </main>

  <!-- Modal: Registrar Pago -->
  <div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="card-header" id="formModalTitle"><i class="fas fa-plus-circle me-2"></i>Registrar Nuevo Pago</div>
        <div class="modal-body">
          <form id="payment-form">
            <div class="mb-3">
              <label class="form-label" for="pharmacy">Nombre de Farmacia</label>
              <input id="pharmacy" type="text" class="form-control" required placeholder="Ej: Droguer√≠a Bucaramanga"/>
            </div>
            <div class="mb-3">
              <label class="form-label" for="product">Producto</label>
              <select id="product" class="form-select" required>
                <option value="">Seleccionar producto</option>
                <option value="descongel">Descongel x100 c√°psulas</option>
                <option value="multidol400">Multidol 400mg</option>
                <option value="multidol800">Multidol 800mg</option>
              </select>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label" for="quantity">Cantidad</label>
                <input id="quantity" type="number" inputmode="numeric" min="1" step="1" class="form-control" required placeholder="Ej: 5"/>
              </div>
              <div class="col-6">
                <label class="form-label" for="unitPrice">Valor Unit. (COP)</label>
                <input id="unitPrice" type="number" inputmode="numeric" min="0" step="100" class="form-control" required placeholder="Ej: 5000"/>
              </div>
            </div>

            <div id="total-container" class="mt-3" style="display:none">
              <div class="alert d-flex align-items-center mb-0" style="background:linear-gradient(135deg,#27ae60,#1f8e4e);color:#fff;border:0">
                <div class="me-3"><i class="fa-solid fa-sack-dollar"></i></div>
                <div>
                  <div class="small">Total a pagar</div>
                  <div id="total-display" class="fw-bold fs-5">$0</div>
                </div>
              </div>
              <input type="hidden" id="total-value" value="">
            </div>

            <div class="row g-2 mt-2">
              <div class="col-6">
                <label class="form-label" for="status">Estado</label>
                <select id="status" class="form-select" required>
                  <option value="pendiente">‚è≥ Pendiente</option>
                  <option value="procesado">‚úÖ Procesado</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label" for="date">Fecha</label>
                <input id="date" type="date" class="form-control" required />
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label" for="notes">Descripci√≥n/Notas</label>
              <textarea id="notes" rows="2" class="form-control" placeholder="Ej: Pago correspondiente a agosto"></textarea>
            </div>

            <div class="d-grid mt-3">
              <button class="btn btn-primary" type="submit"><i class="fas fa-save me-2"></i>Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Editar Pago -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="card-header" id="editModalTitle"><i class="fas fa-pen-to-square me-2"></i>Editar Pago</div>
        <div class="modal-body">
          <form id="edit-form">
            <input type="hidden" id="edit-id" />

            <div class="mb-3">
              <label class="form-label" for="edit-pharmacy">Nombre de Farmacia</label>
              <input id="edit-pharmacy" type="text" class="form-control" required />
            </div>

            <div class="mb-3">
              <label class="form-label" for="edit-product">Producto</label>
              <select id="edit-product" class="form-select" required>
                <option value="descongel">Descongel x100 c√°psulas</option>
                <option value="multidol400">Multidol 400mg</option>
                <option value="multidol800">Multidol 800mg</option>
              </select>
            </div>

            <div class="row g-2">
              <div class="col-6">
                <label class="form-label" for="edit-quantity">Cantidad</label>
                <input id="edit-quantity" type="number" inputmode="numeric" min="1" step="1" class="form-control" required/>
              </div>
              <div class="col-6">
                <label class="form-label" for="edit-unitPrice">Valor Unit. (COP)</label>
                <input id="edit-unitPrice" type="number" inputmode="numeric" min="0" step="100" class="form-control" required/>
              </div>
            </div>

            <div id="edit-total-container" class="mt-3" style="display:none">
              <div class="alert d-flex align-items-center mb-0" style="background:linear-gradient(135deg,#27ae60,#1f8e4e);color:#fff;border:0">
                <div class="me-3"><i class="fa-solid fa-sack-dollar"></i></div>
                <div>
                  <div class="small">Total</div>
                  <div id="edit-total-display" class="fw-bold fs-5">$0</div>
                </div>
              </div>
              <input type="hidden" id="edit-total-value" value="">
            </div>

            <div class="row g-2 mt-2">
              <div class="col-6">
                <label class="form-label" for="edit-status">Estado</label>
                <select id="edit-status" class="form-select" required>
                  <option value="pendiente">‚è≥ Pendiente</option>
                  <option value="procesado">‚úÖ Procesado</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label" for="edit-date">Fecha</label>
                <input id="edit-date" type="date" class="form-control" required />
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label" for="edit-notes">Descripci√≥n/Notas</label>
              <textarea id="edit-notes" rows="2" class="form-control"></textarea>
            </div>

            <div class="d-grid mt-3">
              <button class="btn btn-primary" type="submit"><i class="fas fa-save me-2"></i>Guardar cambios</button>
            </div>
          </form>
        </div>
        <div class="p-3 pt-0 text-end">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Detalles -->
  <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="card-header"><span id="detailsTitle">Pago</span></div>
        <div class="modal-body" id="detailsBody"></div>
        <div class="p-3 pt-0 text-end">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center py-3 text-muted">
    CRM Control de Pagos &copy; 2025 ‚Äî Sistema de gesti√≥n de medicamentos
  </footer>

  <!-- Bot√≥n flotante (desktop/tablet) -->
  <button class="btn btn-primary position-fixed d-none d-md-inline-flex align-items-center justify-content-center js-open-form"
          style="right:18px;bottom:22px;border-radius:28px;width:56px;height:56px" title="Registrar pago">
    <i class="fa fa-plus"></i>
  </button>

  <!-- ========== RUNTIME HEALTH PANEL (carga y filtros) ========== -->
  <style>
    #health-panel{
      position:fixed;right:16px;top:16px;z-index:3000;min-width:280px;
      background:#0b2e13;color:#d1f7d6;border:1px solid #198754; border-radius:12px;
      box-shadow:0 10px 28px rgba(0,0,0,.22); font:13px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
      display:none
    }
    #health-panel header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#146c43;border-radius:12px 12px 0 0}
    #health-panel .body{padding:10px 12px}
    #health-panel .kv{display:flex;justify-content:space-between;gap:10px}
    #health-panel .kv + .kv{margin-top:4px}
    #health-panel .muted{opacity:.85}
    #health-panel .btns{display:flex;gap:8px;margin-top:10px}
    #health-panel button{background:#198754;color:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer}
    #health-panel .ghost{background:transparent;border:1px solid #d1f7d6;color:#d1f7d6}
    #health-panel pre{margin:8px 0 0;background:#0a1f18;border:1px solid #1b5f47;border-radius:8px;color:#c8f3d2;padding:6px;max-height:140px;overflow:auto}
  </style>

  <div id="health-panel" role="status" aria-live="polite">
    <header>
      <strong>Health ‚Ä¢ Pagos</strong>
      <button class="ghost" id="hp-close" title="Ocultar">‚úï</button>
    </header>
    <div class="body">
      <div class="kv"><span>Total A (server):</span><span id="hp-a">‚Äî</span></div>
      <div class="kv"><span>Total B (fecha):</span><span id="hp-b">‚Äî</span></div>
      <div class="kv"><span>Total C (cliente):</span><span id="hp-c">‚Äî</span></div>
      <div class="kv"><span class="muted">Antes de filtros UI:</span><span id="hp-pre">‚Äî</span></div>
      <div class="kv"><span class="muted">Despu√©s filtros UI:</span><span id="hp-post">‚Äî</span></div>
      <div class="kv"><span>Filtros:</span><span id="hp-filters">‚Äî</span></div>
      <div class="btns">
        <button id="hp-reset">Reset filtros</button>
        <button class="ghost" id="hp-copy">Copiar estado</button>
      </div>
      <pre id="hp-log" style="display:none"></pre>
    </div>
  </div>

  <script type="module">
  (() => {
    const $ = s => document.querySelector(s);
    const panel = $('#health-panel');
    const logEl = $('#hp-log');
    const state = { A:null, B:null, C:null, pre:null, post:null, filters:null, trace:[] };

    function show(){ panel.style.display='block'; }
    function hide(){ panel.style.display='none'; }
    $('#hp-close').addEventListener('click', hide);
    $('#hp-copy').addEventListener('click', ()=>{
      navigator.clipboard.writeText(JSON.stringify(state, null, 2)).then(()=>alert('Estado copiado al portapapeles'));
    });
    $('#hp-reset').addEventListener('click', ()=>{
      const f = id => document.getElementById(id);
      if(f('filter-product')) f('filter-product').value = '';
      if(f('filter-status')) f('filter-status').value = '';
      if(f('filter-pharmacy')) f('filter-pharmacy').value = '';
      if(f('filter-date')) f('filter-date').value = '';
      (window.loadPayments || (()=>{}))();
    });

    function setKV(id, val){ const el = document.getElementById(id); if(el) el.textContent = val; }
    function setFiltersKV(){
      const v = (id)=> (document.getElementById(id)?.value || '');
      const filters = {
        product: v('filter-product'),
        status:  v('filter-status'),
        pharmacy:v('filter-pharmacy'),
        month:   v('filter-date')
      };
      state.filters = filters;
      setKV('hp-filters', Object.entries(filters).map(([k,v])=>`${k}:${v||'‚àÖ'}`).join(' ¬∑ '));
    }

    const originalLoad = window.loadPayments;
    if (typeof originalLoad === 'function') {
      window.loadPayments = async function patchedLoadPayments(){
        setFiltersKV();
        show();
        state.trace.push({ t: Date.now(), msg: 'loadPayments() start', filters: state.filters });

        // Stubs globales para marcas A/B/C
        window.__HP_MARK_A__ = (n)=>{ state.A=n; setKV('hp-a', n); };
        window.__HP_MARK_B__ = (n)=>{ state.B=n; setKV('hp-b', n); };
        window.__HP_MARK_C__ = (n)=>{ state.C=n; setKV('hp-c', n); };

        // Proxy de renderPayments para medir pre/post
        const originalRender = window.renderPayments;
        window.renderPayments = function wrappedRender(paymentsRaw){
          state.pre = Array.isArray(paymentsRaw) ? paymentsRaw.length : 0;
          setKV('hp-pre', state.pre);

          try {
            originalRender.apply(this, arguments);
          } finally {
            const tbody = document.getElementById('payments-table');
            const painted = tbody ? tbody.querySelectorAll('tr').length : 0;
            state.post = painted;
            setKV('hp-post', painted);
            state.trace.push({ t: Date.now(), msg: 'render', pre: state.pre, post: state.post });
            logEl.style.display = 'block';
            logEl.textContent = JSON.stringify(state, null, 2);
          }
        };

        try{
          await originalLoad();
        }catch(e){
          state.trace.push({ t: Date.now(), msg: 'loadPayments error', err: String(e?.message||e) });
          logEl.style.display = 'block';
          logEl.textContent = JSON.stringify(state, null, 2) + '\n\nERROR: ' + (e?.stack || e);
          throw e;
        }finally{
          delete window.__HP_MARK_A__;
          delete window.__HP_MARK_B__;
          delete window.__HP_MARK_C__;
          window.renderPayments = originalRender;
        }
      };
    } else {
      show();
      setKV('hp-a','‚Äî'); setKV('hp-b','‚Äî'); setKV('hp-c','‚Äî');
      setKV('hp-pre','‚Äî'); setKV('hp-post','‚Äî');
      setKV('hp-filters','(loadPayments no encontrada)');
    }

    setFiltersKV();
    show();
  })();
  </script>
  <!-- ========== /RUNTIME HEALTH PANEL ========== -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
